<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Sparta</title>
    <meta name="generator" content="Hugo 0.20.2" />

    
    <meta name="description" content="Sparta - Go framework for AWS Lambda">
    
    <link rel="canonical" href="http://gosparta.io/">
    
    <meta name="author" content="Matt Weagle">
    

    <meta property="og:url" content="http://gosparta.io/">
    <meta property="og:title" content="Sparta">
    <meta property="og:image" content="http://gosparta.io/images/SpartaHelmet.png">
    <meta name="apple-mobile-web-app-title" content="Sparta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="http://gosparta.io/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="http://gosparta.io/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('http://gosparta.io/fonts/icon.eot');
        src: url('http://gosparta.io/fonts/icon.eot')
               format('embedded-opentype'),
             url('http://gosparta.io/fonts/icon.woff')
               format('woff'),
             url('http://gosparta.io/fonts/icon.ttf')
               format('truetype'),
             url('http://gosparta.io/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="http://gosparta.io/stylesheets/application.css">
    <link rel="stylesheet" href="http://gosparta.io/stylesheets/temporary.css">
    <link rel="stylesheet" href="http://gosparta.io/stylesheets/palettes.css">
    <link rel="stylesheet" href="http://gosparta.io/highlights_js/styles/vs.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source%20Sans%20Pro:400,700|Source&#43;Code&#43;Pro">
    <style>
      body, input {
        font-family: 'Source Sans Pro', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Source Code Pro', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <link rel="stylesheet" href="http://gosparta.io/mermaid_dist/mermaid.css">
    
    <link rel="stylesheet" href="http://gosparta.io/font-awesome-4.7.0/css/font-awesome.min.css">
    
    <script src="http://gosparta.io/javascripts/modernizr.js"></script>

    
    <link href="http://gosparta.io/index.xml" rel="alternate" type="application/rss+xml" title="Sparta" />
    <link href="http://gosparta.io/index.xml" rel="feed" type="application/rss+xml" title="Sparta" />
    

  </head>
  <body class="palette-primary-grey palette-accent-blue">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Sparta
      </div>
    </div>

    
    <div class="button button-twitter" role="button" aria-label="Twitter">
       <a href="https://twitter.com/mweagle" title="@mweagle on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
    </div>
    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/mweagle" title="@mweagle on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/mweagle/Sparta" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="http://gosparta.io/images/SpartaHelmet.png">
        </div>
      
      <div class="name">
        <strong>Sparta <span class="version">1.0.0</span></strong>
        
          <br>
          mweagle/Sparta
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/mweagle/Sparta/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/mweagle/Sparta/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Sparta" href="http://gosparta.io/landing">
	
	Sparta
</a>



  
</li>



<li>
  
    



<a  title="Overview" href="http://gosparta.io/docs/overview">
	
	Overview
</a>



  
</li>



<li>
  
    <span class="section">Documentation</span>
    <ul>
      
        
        



<a  title="API Gateway" href="http://gosparta.io/docs/apigateway/apigateway/">
	
	API Gateway
</a>



      
        
        



<a  title="Alternative Topologies" href="http://gosparta.io/docs/alternative_topologies/">
	
	Alternative Topologies
</a>



      
        
        



<a  title="Application Customization" href="http://gosparta.io/docs/application/application/">
	
	Application Customization
</a>



      
        
        



<a  title="CGO" href="http://gosparta.io/docs/cgo/">
	
	CGO
</a>



      
        
        



<a  title="Custom Resources" href="http://gosparta.io/docs/custom_resources/">
	
	Custom Resources
</a>



      
        
        



<a  title="Discovery Service" href="http://gosparta.io/docs/discovery/">
	
	Discovery Service
</a>



      
        
        



<a  title="Docker" href="http://gosparta.io/docs/docker/">
	
	Docker
</a>



      
        
        



<a  title="Dynamic Infrastructure" href="http://gosparta.io/docs/dynamic_infrastructure/">
	
	Dynamic Infrastructure
</a>



      
        
        



<a  title="Event Sources" href="http://gosparta.io/docs/eventsources/eventsources/">
	
	Event Sources
</a>



      
        
        



<a  title="Limitations" href="http://gosparta.io/docs/limitations/">
	
	Limitations
</a>



      
        
        



<a  title="Local Testing" href="http://gosparta.io/docs/local_testing/">
	
	Local Testing
</a>



      
        
        



<a  title="S3 Sites with CORS" href="http://gosparta.io/docs/s3site/">
	
	S3 Sites with CORS
</a>



      
        
        



<a  title="Sample Service" href="http://gosparta.io/docs/intro_example/">
	
	Sample Service
</a>



      
        
        



<a  title="Sample Service - Details" href="http://gosparta.io/docs/intro_examples_details/">
	
	Sample Service - Details
</a>



      
    </ul>
  
</li>



<li>
  
    



<a  title="FAQ" href="http://gosparta.io/docs/faq">
	
	FAQ
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          
          <li>
            <a href="https://twitter.com/mweagle" target="_blank" title="@mweagle on Twitter">
              @mweagle on Twitter
            </a>
          </li>
          

          
          <li>
            <a href="https://github.com/mweagle" target="_blank" title="@mweagle on GitHub">
              @mweagle on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:mweagle@gmail.com" title="Email of mweagle@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			
				<h1>API Gateway </h1>

				

<h2 id="examples">Examples</h2>

<p>One of the most powerful ways to use AWS Lambda is to make function publicly available over HTTPS.  This is accomplished by connecting the AWS Lambda function with the <a href="https://aws.amazon.com/api-gateway/">API Gateway</a>.  In this section we&rsquo;ll start with a simple &ldquo;echo&rdquo; example and move on to a lambda function that accepts user parameters and returns an expiring S3 URL.</p>

<ul>
<li><a href="http://gosparta.io/docs/apigateway/example1">Example 1 - Echo Event</a></li>
<li><a href="http://gosparta.io/docs/apigateway/example2">Example 2 - User Input &amp; JSON Response</a></li>
<li><a href="http://gosparta.io/docs/apigateway/example3">Example 3 - Request Context</a></li>
<li><a href="http://gosparta.io/docs/apigateway/slack">Example 4 - Slack SlashCommand</a></li>
<li><a href="http://gosparta.io/docs/apigateway/cors">Example 5 - CORS</a></li>
</ul>

<h2 id="concepts">Concepts</h2>

<p>Before moving on to the examples, it&rsquo;s suggested you familiarize yourself with the API Gateway concepts.</p>

<ul>
<li><a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/getting-started-intro.html">Gettting Started with Amazon API Gateway</a></li>
</ul>

<p>The API Gateway presents a powerful and complex domain model.  In brief, to integrate with the API Gateway, a service must:</p>

<ol>
<li>Define one or more AWS Lambda functions</li>
<li>Create an API Gateway REST API instance</li>
<li>Create one or more resources associated with the REST API</li>
<li>Create one or more methods for each resource</li>
<li>For each method:

<ol>
<li>Define the method request params</li>
<li>Define the integration request mapping</li>
<li>Define the integration response mapping</li>
<li>Define the method response mapping</li>
</ol></li>
<li>Create a stage for a REST API</li>
<li>Deploy the given stage</li>
</ol>

<p>With that overview, let&rsquo;s start with a simple <a href="http://gosparta.io/docs/apigateway/example1">example</a>.</p>

<h2 id="custom-http-headers">Custom HTTP Headers</h2>

<p>API Gateway supports returning custom HTTP headers whose values are extracted from your response payload.</p>

<p>Assume your Sparta lambda function returns a JSON struct as in:</p>

<pre><code class="go">// API response struct
type helloWorldResponse struct {
  Location string `json:&#34;location&#34;`
  Body     string `json:&#34;body&#34;`
}</code></pre>


<p>To extract the <code>location</code> field and promote it to the HTTP <code>Location</code> header, you must configure the <a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html">response data mappings</a>:</p>

<pre><code class="go">//
// Promote the location key value to an HTTP header
//
lambdaFn := sparta.NewLambda(sparta.IAMRoleDefinition{}, helloWorldResponseFunc, nil)
	apiGatewayResource, _ := api.NewResource(&#34;/hello&#34;, lambdaFn)

apiGWMethod, _ := apiGatewayResource.NewMethod(&#34;GET&#34;, http.StatusOK)
apiGWMethod.Responses[http.StatusOK].Parameters = map[string]bool{
  &#34;method.response.header.Location&#34;: true,
}
apiGWMethod.Integration.Responses[http.StatusOK].Parameters[&#34;method.response.header.Location&#34;] =
  &#34;integration.response.body.location&#34;</code></pre>


<p>See the related <a href="https://forums.aws.amazon.com/thread.jspa?threadID=199443">AWS Forum thread</a>.</p>

<h2 id="other-resources">Other Resources</h2>

<ul>
<li><a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/getting-started.html">Walkthrough: API Gateway and Lambda Functions</a></li>
</ul>

			
				<h1>API Gateway - Echo </h1>

				

<p>To start, we&rsquo;ll create a HTTPS accessible lambda function that simply echoes back the contents of the Lambda event.  The source for this is the <a href="https://github.com/mweagle/SpartaApplication">SpartaApplication</a>.</p>

<p>For reference, the <code>echoS3Event</code> function is below.</p>

<pre><code class="go">func echoS3Event(event *json.RawMessage,
                  context *sparta.LambdaContext,
                  w http.ResponseWriter,
                  logger *logrus.Logger) {

  logger.WithFields(logrus.Fields{
    &#34;RequestID&#34;: context.AWSRequestID,
    &#34;Event&#34;:     string(*event),
  }).Info(&#34;Request received&#34;)

  fmt.Fprintf(w, string(*event))
}</code></pre>


<h1 id="create-the-api-gateway">Create the API Gateway</h1>

<p>The first requirement is to create a new <a href="https://godoc.org/github.com/mweagle/Sparta#API">API</a> instance via <code>sparta.NewAPIGateway()</code></p>

<pre><code class="go">stage := sparta.NewStage(&#34;prod&#34;)
apiGateway := sparta.NewAPIGateway(&#34;MySpartaAPI&#34;, stage)</code></pre>


<p>In the example above, we&rsquo;re also including a <a href="https://godoc.org/github.com/mweagle/Sparta#Stage">Stage</a> value.  A non-<code>nil</code> Stage value will cause the registered API to be deployed.  If the Stage value is <code>nil</code>, a REST API will be created, but it will not be <a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-deploy-api.html">deployed</a> (and therefore not publicly accessible).</p>

<h1 id="create-a-resource">Create a Resource</h1>

<p>The next step is to associate a URL path with the <code>sparta.LambdaAWSInfo</code> struct that represents the <strong>Go</strong> function:</p>

<pre><code class="go">apiGatewayResource, _ := api.NewResource(&#34;/hello/world/test&#34;, lambdaFn)
apiGatewayResource.NewMethod(&#34;GET&#34;, http.StatusOK)</code></pre>


<p>Our <a href="https://github.com/mweagle/SpartaApplication/blob/master/application.go#L34">echoS3Event</a> only supports <code>GET</code>.  We&rsquo;ll see how a single lambda function can support multiple HTTP methods shortly.</p>

<h1 id="provision">Provision</h1>

<p>The final step is to to provide the API instance to <code>Sparta.Main()</code></p>

<pre><code class="go">stage := sparta.NewStage(&#34;prod&#34;)
apiGateway := sparta.NewAPIGateway(&#34;MySpartaAPI&#34;, stage)
stackName := &#34;SpartaApplication&#34;
sparta.Main(stackName,
  &#34;Simple Sparta application&#34;,
  spartaLambdaData(apiGateway),
  apiGateway,
  nil)</code></pre>


<p>Once the service is successfully provisioned, the <code>Outputs</code> key will include the API Gateway Deployed URL (sample):</p>

<pre><code class="javascript">INFO[0113] Stack output   Description=API Gateway URL Key=APIGatewayURL Value=https://7ljn63rysd.execute-api.us-west-2.amazonaws.com/prod
INFO[0113] Stack output   Description=Sparta Home Key=SpartaHome Value=https://github.com/mweagle/Sparta
INFO[0113] Stack output   Description=Sparta Version Key=SpartaVersion Value=0.1.0</code></pre>


<p>Combining the <em>API Gateway URL</em> <code>OutputValue</code> with our resource path (<em>/hello/world/test</em>), we get the absolute URL to our lambda function: <em><a href="https://7ljn63rysd.execute-api.us-west-2.amazonaws.com/prod/hello/world/test">https://7ljn63rysd.execute-api.us-west-2.amazonaws.com/prod/hello/world/test</a></em></p>

<h1 id="querying">Querying</h1>

<p>Let&rsquo;s query the lambda function and see what the <code>event</code> data is at execution time:</p>

<pre><code class="nohighlight">curl -vs https://7ljn63rysd.execute-api.us-west-2.amazonaws.com/prod/hello/world/test
*   Trying 54.240.188.223...
* Connected to 7ljn63rysd.execute-api.us-west-2.amazonaws.com (54.240.188.223) port 443 (#0)
* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate: *.execute-api.us-west-2.amazonaws.com
* Server certificate: Symantec Class 3 Secure Server CA - G4
* Server certificate: VeriSign Class 3 Public Primary Certification Authority - G5
&gt; GET /prod/hello/world/test HTTP/1.1
&gt; Host: 7ljn63rysd.execute-api.us-west-2.amazonaws.com
&gt; User-Agent: curl/7.43.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Content-Type: application/json
&lt; Content-Length: 708
&lt; Connection: keep-alive
&lt; Date: Sat, 05 Dec 2015 21:24:44 GMT
&lt; x-amzn-RequestId: 99dfd15d-9b96-11e5-9705-fdd3a4d9c8bf
&lt; X-Cache: Miss from cloudfront
&lt; Via: 1.1 7a0918c01bce16cc9b165fd895f7dc87.cloudfront.net (CloudFront)
&lt; X-Amz-Cf-Id: rx1cVURKTlc3sla3v59Ekz1YMfVdcUWG1QwFKCFPjjLzHzmL_d6r_w==
&lt;
* Connection #0 to host 7ljn63rysd.execute-api.us-west-2.amazonaws.com left intact
{&#34;method&#34;:&#34;GET&#34;,&#34;body&#34;:{},&#34;headers&#34;:{&#34;Accept&#34;:&#34;*/*&#34;,&#34;CloudFront-Forwarded-Proto&#34;:&#34;https&#34;,&#34;CloudFront-Is-Desktop-Viewer&#34;:&#34;true&#34;,&#34;CloudFront-Is-Mobile-Viewer&#34;:&#34;false&#34;,&#34;CloudFront-Is-SmartTV-Viewer&#34;:&#34;false&#34;,&#34;CloudFront-Is-Tablet-Viewer&#34;:&#34;false&#34;,&#34;CloudFront-Viewer-Country&#34;:&#34;US&#34;,&#34;Via&#34;:&#34;1.1 5c98e8df8806ae26f9ae3c33615610d2.cloudfront.net (CloudFront)&#34;,&#34;X-Amz-Cf-Id&#34;:&#34;sRMCwKpH3jIPbwgIo4pPHv_YJXEo9KEojEFw8yrljFVP2krJbyewLg==&#34;,&#34;X-Forwarded-For&#34;:&#34;50.135.43.1, 54.240.158.211&#34;,&#34;X-Forwarded-Port&#34;:&#34;443&#34;,&#34;X-Forwarded-Proto&#34;:&#34;https&#34;},&#34;queryParams&#34;:{},&#34;pathParams&#34;:{},&#34;context&#34;:{&#34;apiId&#34;:&#34;bmik0opc3l&#34;,&#34;method&#34;:&#34;GET&#34;,&#34;requestId&#34;:&#34;c113fd3b-a76b-11e5-b5e6-4ff04e5da412&#34;,&#34;resourceId&#34;:&#34;mp2mrk&#34;,&#34;resourcePath&#34;:&#34;/hello/world/test&#34;,&#34;stage&#34;:&#34;prod&#34;,&#34;identity&#34;:{&#34;accountId&#34;:&#34;&#34;,&#34;apiKey&#34;:&#34;&#34;,&#34;caller&#34;:&#34;&#34;,&#34;cognitoAuthenticationProvider&#34;:&#34;&#34;,&#34;cognitoAuthenticationType&#34;:&#34;&#34;,&#34;cognitoIdentityId&#34;:&#34;&#34;,&#34;cognitoIdentityPoolId&#34;:&#34;&#34;,&#34;sourceIp&#34;:&#34;50.135.43.1&#34;,&#34;user&#34;:&#34;&#34;,&#34;userAgent&#34;:&#34;curl/7.43.0&#34;,&#34;userArn&#34;:&#34;&#34;}}}</code></pre>


<p>Pretty-printing the response body to make things more readable:</p>

<pre><code class="json">{
  &#34;method&#34;: &#34;GET&#34;,
  &#34;body&#34;: {},
  &#34;headers&#34;: {
    &#34;Accept&#34;: &#34;*/*&#34;,
    &#34;CloudFront-Forwarded-Proto&#34;: &#34;https&#34;,
    &#34;CloudFront-Is-Desktop-Viewer&#34;: &#34;true&#34;,
    &#34;CloudFront-Is-Mobile-Viewer&#34;: &#34;false&#34;,
    &#34;CloudFront-Is-SmartTV-Viewer&#34;: &#34;false&#34;,
    &#34;CloudFront-Is-Tablet-Viewer&#34;: &#34;false&#34;,
    &#34;CloudFront-Viewer-Country&#34;: &#34;US&#34;,
    &#34;Via&#34;: &#34;1.1 5c98e8df8806ae26f9ae3c33615610d2.cloudfront.net (CloudFront)&#34;,
    &#34;X-Amz-Cf-Id&#34;: &#34;sRMCwKpH3jIPbwgIo4pPHv_YJXEo9KEojEFw8yrljFVP2krJbyewLg==&#34;,
    &#34;X-Forwarded-For&#34;: &#34;50.135.43.1, 54.240.158.211&#34;,
    &#34;X-Forwarded-Port&#34;: &#34;443&#34;,
    &#34;X-Forwarded-Proto&#34;: &#34;https&#34;
  },
  &#34;queryParams&#34;: {},
  &#34;pathParams&#34;: {},
  &#34;context&#34;: {
    &#34;apiId&#34;: &#34;bmik0opc3l&#34;,
    &#34;method&#34;: &#34;GET&#34;,
    &#34;requestId&#34;: &#34;c113fd3b-a76b-11e5-b5e6-4ff04e5da412&#34;,
    &#34;resourceId&#34;: &#34;mp2mrk&#34;,
    &#34;resourcePath&#34;: &#34;/hello/world/test&#34;,
    &#34;stage&#34;: &#34;prod&#34;,
    &#34;identity&#34;: {
      &#34;accountId&#34;: &#34;&#34;,
      &#34;apiKey&#34;: &#34;&#34;,
      &#34;caller&#34;: &#34;&#34;,
      &#34;cognitoAuthenticationProvider&#34;: &#34;&#34;,
      &#34;cognitoAuthenticationType&#34;: &#34;&#34;,
      &#34;cognitoIdentityId&#34;: &#34;&#34;,
      &#34;cognitoIdentityPoolId&#34;: &#34;&#34;,
      &#34;sourceIp&#34;: &#34;50.135.43.1&#34;,
      &#34;user&#34;: &#34;&#34;,
      &#34;userAgent&#34;: &#34;curl/7.43.0&#34;,
      &#34;userArn&#34;: &#34;&#34;
    }
  }
}</code></pre>


<p>While this demonstrates that our lambda function is publicly accessible, it&rsquo;s not immediately obvious where the <code>*event</code> data is being populated.</p>

<h1 id="mapping-templates">Mapping Templates</h1>

<p>The event data that&rsquo;s actually supplied to <code>echoS3Event</code> is the complete HTTP response body.  This content is what the API Gateway sends to our lambda function, which is defined by  the integration mapping.  This event data also includes the values of any whitelisted parameters.  When the API Gateway Method is defined, it optionally includes any  whitelisted query params and header values that should be forwarded to the integration target.  For this example, we&rsquo;re not whitelisting any params, so those fields (<code>queryParams</code>, <code>pathParams</code>) are empty.  Then for each integration target (which can be AWS Lambda, a mock, or a HTTP Proxy), it&rsquo;s possible to transform the API Gateway request data and whitelisted arguments into a format that&rsquo;s more amenable to the target.</p>

<p>Sparta uses a pass-through template that passes all valid data, with minor <strong>Body</strong> differences based on the inbound <em>Content-Type</em>:</p>

<ul>
<li><a href="https://github.com/mweagle/Sparta/blob/master/resources/provision/apigateway/inputmapping_json.vtl">application/json</a></li>
<li><a href="https://github.com/mweagle/Sparta/blob/master/resources/provision/apigateway/inputmapping_default.vtl">*</a></li>
</ul>

<p>The <code>application/json</code> template is copied below:</p>

<pre><code class="nohighlight">#*
Provide an automatic pass through template that transforms all inputs
into the JSON payload sent to a golang function

See
  https://forums.aws.amazon.com/thread.jspa?threadID=220274&amp;tstart=0
  http://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html
*#
{
  &#34;method&#34;: &#34;$context.httpMethod&#34;,
  &#34;body&#34; : $input.json(&#39;$&#39;),
  &#34;headers&#34;: {
    #foreach($param in $input.params().header.keySet())
    &#34;$param&#34;: &#34;$util.escapeJavaScript($input.params().header.get($param))&#34; #if($foreach.hasNext),#end

    #end
  },
  &#34;queryParams&#34;: {
    #foreach($param in $input.params().querystring.keySet())
    &#34;$param&#34;: &#34;$util.escapeJavaScript($input.params().querystring.get($param))&#34; #if($foreach.hasNext),#end

    #end
  },
  &#34;pathParams&#34;: {
    #foreach($param in $input.params().path.keySet())
    &#34;$param&#34;: &#34;$util.escapeJavaScript($input.params().path.get($param))&#34; #if($foreach.hasNext),#end

    #end
  },
  &#34;context&#34; : {
    &#34;apiId&#34; : &#34;$util.escapeJavaScript($context.apiId)&#34;,
    &#34;method&#34; : &#34;$util.escapeJavaScript($context.httpMethod)&#34;,
    &#34;requestId&#34; : &#34;$util.escapeJavaScript($context.requestId)&#34;,
    &#34;resourceId&#34; : &#34;$util.escapeJavaScript($context.resourceId)&#34;,
    &#34;resourcePath&#34; : &#34;$util.escapeJavaScript($context.resourcePath)&#34;,
    &#34;stage&#34; : &#34;$util.escapeJavaScript($context.stage)&#34;,
    &#34;identity&#34; : {
      &#34;accountId&#34; : &#34;$util.escapeJavaScript($context.identity.accountId)&#34;,
      &#34;apiKey&#34; : &#34;$util.escapeJavaScript($context.identity.apiKey)&#34;,
      &#34;caller&#34; : &#34;$util.escapeJavaScript($context.identity.caller)&#34;,
      &#34;cognitoAuthenticationProvider&#34; : &#34;$util.escapeJavaScript($context.identity.cognitoAuthenticationProvider)&#34;,
      &#34;cognitoAuthenticationType&#34; : &#34;$util.escapeJavaScript($context.identity.cognitoAuthenticationType)&#34;,
      &#34;cognitoIdentityId&#34; : &#34;$util.escapeJavaScript($context.identity.cognitoIdentityId)&#34;,
      &#34;cognitoIdentityPoolId&#34; : &#34;$util.escapeJavaScript($context.identity.cognitoIdentityPoolId)&#34;,
      &#34;sourceIp&#34; : &#34;$util.escapeJavaScript($context.identity.sourceIp)&#34;,
      &#34;user&#34; : &#34;$util.escapeJavaScript($context.identity.user)&#34;,
      &#34;userAgent&#34; : &#34;$util.escapeJavaScript($context.identity.userAgent)&#34;,
      &#34;userArn&#34; : &#34;$util.escapeJavaScript($context.identity.userArn)&#34;
    }
  }
}</code></pre>


<p>This template forwards all whitelisted data &amp; body to the lambda function.  You can see by switching on the <code>method</code> field would permit a single function to service multiple HTTP method names.</p>

<p>The next example will show how to unmarshal this data and perform request-specific actions.</p>

<h1 id="proxying-envelope">Proxying Envelope</h1>

<p>Because the integration request returned a successful response, the API Gateway response body contains only our lambda&rsquo;s output.</p>

<p>If there were an error, the response would include additional fields (<code>code</code>, <code>status</code>, <code>headers</code>).  Those fields are injected by the NodeJS proxying tier as part of translating the <strong>Go</strong> HTTP response to a Lambda compatible result.</p>

<p>A primary benefit of this envelope is to provide an automatic mapping from Integration Error Response Regular Expression mappings to Method Response codes.  If you look at the <strong>Integration Response</strong> section of the <em>/hello/world/test</em> resource in the Console, you&rsquo;ll see a list of Regular Expression matches:</p>

<p><img src="http://gosparta.io/images/apigateway/IntegrationMapping.png" alt="API Gateway" /></p>

<p>The regular expressions are used to translate the integration response, which is just a blob of text provided to <code>context.done()</code>, into API Gateway Method responses.  Sparta annotates your lambda functions response with <strong>Go</strong>&rsquo;s <a href="https://golang.org/src/net/http/status.go">HTTP StatusText</a> values based on the HTTP status code your lambda function produced.  Sparta also provides a corresponding Method Response entry for all valid HTTP codes:</p>

<p><img src="http://gosparta.io/images/apigateway/MethodResponse.png" alt="API Gateway" /></p>

<p>These mappings are defaults, and it&rsquo;s possible to override either one by providing a non-zero length values to either:</p>

<ul>
<li><a href="https://godoc.org/github.com/mweagle/Sparta#Integration">Integration.Responses</a>.  See the <a href="https://github.com/mweagle/Sparta/blob/master/apigateway.go#L60">DefaultIntegrationResponses</a> for the default values.</li>
<li><a href="https://godoc.org/github.com/mweagle/Sparta#Method">Method.Responses</a>.  See the <a href="https://godoc.org/github.com/mweagle/Sparta#DefaultMethodResponses">DefaultMethodResponses</a> for the default method response mappings.</li>
</ul>

<h1 id="cleaning-up">Cleaning Up</h1>

<p>Before moving on, remember to decommission the service via:</p>

<pre><code class="nohighlight">go run application.go delete</code></pre>


<h1 id="wrapping-up">Wrapping Up</h1>

<p>Now that we know what data is actually being sent to our API Gateway-connected Lambda function, we&rsquo;ll move on to performing a more complex operation, including returning a custom HTTP response body.</p>

<h1 id="other-resources">Other Resources</h1>

<ul>
<li><a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html">Mapping Template Reference</a></li>
</ul>

			
				<h1>API Gateway - Request Context </h1>

				

<p>This example demonstrates how to use the <code>Context</code> struct provided as part of the <a href="https://godoc.org/github.com/mweagle/Sparta#APIGatewayLambdaJSONEvent">APIGatewayLambdaJSONEvent</a> event.  The <a href="https://github.com/mweagle/SpartaGeoIP">SpartaGeoIP</a> service will return Geo information based on the inbound request&rsquo;s IP address.</p>

<h1 id="define-the-lambda-function">Define the Lambda Function</h1>

<p>Our function will examine the inbound request, lookup the user&rsquo;s IP address in the <a href="http://dev.maxmind.com/geoip/geoip2/geolite2/">GeoLite2 Database</a> and return any information to the client.</p>

<p>As this function is only expected to be invoked from the API Gateway, we&rsquo;ll unmarshall the inbound event:</p>

<pre><code class="go">func ipGeoLambda(event *json.RawMessage,
                  context *sparta.LambdaContext,
                  w http.ResponseWriter,
                  logger *logrus.Logger) {
var lambdaEvent sparta.APIGatewayLambdaJSONEvent
err := json.Unmarshal([]byte(*event), &amp;lambdaEvent)
if err != nil {
	logger.Error(&#34;Failed to unmarshal event data: &#34;, err.Error())
	http.Error(w, err.Error(), http.StatusInternalServerError)
	return
}</code></pre>


<p>We&rsquo;ll then parse the inbound IP address from the <a href="https://godoc.org/github.com/mweagle/Sparta#APIGatewayContext">Context</a> and perform a lookup against the database handle opened in the <a href="https://github.com/mweagle/SpartaGeoIP/blob/master/main.go#L19">init</a> block:</p>

<pre><code class="go">parsedIP := net.ParseIP(lambdaEvent.Context.Identity.SourceIP)
record, err := dbHandle.City(parsedIP)
if err != nil {
  logger.Error(&#34;Failed to find city: &#34;, err.Error())
  http.Error(w, err.Error(), http.StatusInternalServerError)
  return
}</code></pre>


<p>Finally, marshal the data or error result and we&rsquo;re done:</p>

<pre><code class="go">// Return the Info
httpResponse := map[string]interface{}{
  &#34;info&#34;: record,
}
responseBody, err := json.Marshal(httpResponse)
if err != nil {
  http.Error(w, err.Error(), http.StatusInternalServerError)
} else {
  w.Header().Set(&#34;Content-Type&#34;, &#34;application/json&#34;)
  fmt.Fprint(w, string(responseBody))
}</code></pre>


<h1 id="sparta-integration">Sparta Integration</h1>

<p>The next steps are to:</p>

<ol>
<li>Create the <a href="https://godoc.org/github.com/mweagle/Sparta#LambdaAWSInfo">LambdaAWSInfo</a> value</li>
<li>Create an associated API Gateway</li>
<li>Create an API Gateway resource that invokes our lambda function</li>
<li>Add a Method name to the resource.</li>
</ol>

<p>These four steps are managed in the service&rsquo;s <code>main()</code> function:</p>

<pre><code class="go">////////////////////////////////////////////////////////////////////////////////
// Main
func main() {
	stage := sparta.NewStage(&#34;ipgeo&#34;)
	apiGateway := sparta.NewAPIGateway(&#34;SpartaGeoIPService&#34;, stage)
	stackName := &#34;SpartaGeoIP&#34;

	var lambdaFunctions []*sparta.LambdaAWSInfo
	lambdaFn := sparta.NewLambda(sparta.IAMRoleDefinition{}, ipGeoLambda, nil)
	apiGatewayResource, _ := apiGateway.NewResource(&#34;/info&#34;, lambdaFn)
	apiGatewayResource.NewMethod(&#34;GET&#34;, http.StatusOK)
	lambdaFunctions = append(lambdaFunctions, lambdaFn)

	sparta.Main(stackName,
		&#34;Sparta app supporting ip-&gt;geo mapping&#34;,
		lambdaFunctions,
		apiGateway,
    nil)
}</code></pre>


<h1 id="provision">Provision</h1>

<p>The next step is to provision the stack:</p>

<pre><code class="nohighlight">S3_BUCKET=&lt;MY-S3-BUCKETNAME&gt; make provision</code></pre>


<p>Assuming all goes well, the log output will include the API Gateway URL as in:</p>

<pre><code class="nohighlight">INFO[0113] Stack output   Description=API Gateway URL Key=APIGatewayURL Value=https://qyslujefsf.execute-api.us-west-2.amazonaws.com/ipgeo
INFO[0113] Stack output   Description=Sparta Home Key=SpartaHome Value=https://github.com/mweagle/Sparta
INFO[0113] Stack output   Description=Sparta Version Key=SpartaVersion Value=0.1.0</code></pre>


<h1 id="query">Query</h1>

<p>With the API Gateway provisioned, let&rsquo;s check the response:</p>

<pre><code class="nohighlight">curl -vs https://qyslujefsf.execute-api.us-west-2.amazonaws.com/ipgeo/info

*   Trying 54.192.70.206...
* Connected to qyslujefsf.execute-api.us-west-2.amazonaws.com (54.192.70.206) port 443 (#0)
* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate: *.execute-api.us-west-2.amazonaws.com
* Server certificate: Symantec Class 3 Secure Server CA - G4
* Server certificate: VeriSign Class 3 Public Primary Certification Authority - G5
&gt; GET /ipgeo/info HTTP/1.1
&gt; Host: qyslujefsf.execute-api.us-west-2.amazonaws.com
&gt; User-Agent: curl/7.43.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Content-Type: application/json
&lt; Content-Length: 1129
&lt; Connection: keep-alive
&lt; Date: Sun, 06 Dec 2015 21:50:18 GMT
&lt; x-amzn-RequestId: 572adc18-9c63-11e5-b827-81d99c02192f
&lt; X-Cache: Miss from cloudfront
&lt; Via: 1.1 29bfa9b96f4ea66dc02526ee845ca6b0.cloudfront.net (CloudFront)
&lt; X-Amz-Cf-Id: 5mXHuOlbDyk5CejDouAy7nUS3YUn4eXJdQWzU_1VqX9Yh5PE_BdlAw==
&lt;
* Connection #0 to host qyslujefsf.execute-api.us-west-2.amazonaws.com left intact
{&#34;code&#34;:200,&#34;status&#34;:&#34;OK&#34;,&#34;headers&#34;:{&#34;content-type&#34;:&#34;application/json&#34;,&#34;date&#34;:&#34;Sun, 06 Dec 2015 21:50:18 GMT&#34;,&#34;content-length&#34;:&#34;984&#34;},&#34;results&#34;:{&#34;info&#34;:{&#34;City&#34;:{&#34;GeoNameID&#34;:0,&#34;Names&#34;:null},&#34;Continent&#34;:{&#34;Code&#34;:&#34;NA&#34;,&#34;GeoNameID&#34;:6255149,&#34;Names&#34;:{&#34;de&#34;:&#34;Nordamerika&#34;,&#34;en&#34;:&#34;North America&#34;,&#34;es&#34;:&#34;Norteamérica&#34;,&#34;fr&#34;:&#34;Amérique du Nord&#34;,&#34;ja&#34;:&#34;北アメリカ&#34;,&#34;pt-BR&#34;:&#34;América do Norte&#34;,&#34;ru&#34;:&#34;Северная Америка&#34;,&#34;zh-CN&#34;:&#34;北美洲&#34;}},&#34;Country&#34;:{&#34;GeoNameID&#34;:6252001,&#34;IsoCode&#34;:&#34;US&#34;,&#34;Names&#34;:{&#34;de&#34;:&#34;USA&#34;,&#34;en&#34;:&#34;United States&#34;,&#34;es&#34;:&#34;Estados Unidos&#34;,&#34;fr&#34;:&#34;États-Unis&#34;,&#34;ja&#34;:&#34;アメリカ合衆国&#34;,&#34;pt-BR&#34;:&#34;Estados Unidos&#34;,&#34;ru&#34;:&#34;США&#34;,&#34;zh-CN&#34;:&#34;美国&#34;}},&#34;Location&#34;:{&#34;Latitude&#34;:0,&#34;Longitude&#34;:0,&#34;MetroCode&#34;:0,&#34;TimeZone&#34;:&#34;&#34;},&#34;Postal&#34;:{&#34;Code&#34;:&#34;&#34;},&#34;RegisteredCountry&#34;:{&#34;GeoNameID&#34;:6252001,&#34;IsoCode&#34;:&#34;US&#34;,&#34;Names&#34;:{&#34;de&#34;:&#34;USA&#34;,&#34;en&#34;:&#34;United States&#34;,&#34;es&#34;:&#34;Estados Unidos&#34;,&#34;fr&#34;:&#34;États-Unis&#34;,&#34;ja&#34;:&#34;アメリカ合衆国&#34;,&#34;pt-BR&#34;:&#34;Estados Unidos&#34;,&#34;ru&#34;:&#34;США&#34;,&#34;zh-CN&#34;:&#34;美国&#34;}},&#34;RepresentedCountry&#34;:{&#34;GeoNameID&#34;:0,&#34;IsoCode&#34;:&#34;&#34;,&#34;Names&#34;:null,&#34;Type&#34;:&#34;&#34;},&#34;Subdivisions&#34;:null,&#34;Traits&#34;:{&#34;IsAnonymousProxy&#34;:false,&#34;IsSatelliteProvider&#34;:false}}}}</code></pre>


<p>Pretty-printing the response body:</p>

<pre><code class="language-json">{
  &quot;code&quot;: 200,
  &quot;status&quot;: &quot;OK&quot;,
  &quot;headers&quot;: {
    &quot;content-type&quot;: &quot;application/json&quot;,
    &quot;date&quot;: &quot;Sun, 06 Dec 2015 17:50:15 GMT&quot;,
    &quot;content-length&quot;: &quot;984&quot;
  },
  &quot;results&quot;: {
    &quot;info&quot;: {
      &quot;City&quot;: {
        &quot;GeoNameID&quot;: 0,
        &quot;Names&quot;: null
      },
      &quot;Continent&quot;: {
        &quot;Code&quot;: &quot;NA&quot;,
        &quot;GeoNameID&quot;: 6255149,
        &quot;Names&quot;: {
          &quot;de&quot;: &quot;Nordamerika&quot;,
          &quot;en&quot;: &quot;North America&quot;,
          &quot;es&quot;: &quot;Norteamérica&quot;,
          &quot;fr&quot;: &quot;Amérique du Nord&quot;,
          &quot;ja&quot;: &quot;北アメリカ&quot;,
          &quot;pt-BR&quot;: &quot;América do Norte&quot;,
          &quot;ru&quot;: &quot;Северная Америка&quot;,
          &quot;zh-CN&quot;: &quot;北美洲&quot;
        }
      },
      &quot;Country&quot;: {
        &quot;GeoNameID&quot;: 6252001,
        &quot;IsoCode&quot;: &quot;US&quot;,
        &quot;Names&quot;: {
          &quot;de&quot;: &quot;USA&quot;,
          &quot;en&quot;: &quot;United States&quot;,
          &quot;es&quot;: &quot;Estados Unidos&quot;,
          &quot;fr&quot;: &quot;États-Unis&quot;,
          &quot;ja&quot;: &quot;アメリカ合衆国&quot;,
          &quot;pt-BR&quot;: &quot;Estados Unidos&quot;,
          &quot;ru&quot;: &quot;США&quot;,
          &quot;zh-CN&quot;: &quot;美国&quot;
        }
      },
      &quot;Location&quot;: {
        &quot;Latitude&quot;: 0,
        &quot;Longitude&quot;: 0,
        &quot;MetroCode&quot;: 0,
        &quot;TimeZone&quot;: &quot;&quot;
      },
      &quot;Postal&quot;: {
        &quot;Code&quot;: &quot;&quot;
      },
      &quot;RegisteredCountry&quot;: {
        &quot;GeoNameID&quot;: 6252001,
        &quot;IsoCode&quot;: &quot;US&quot;,
        &quot;Names&quot;: {
          &quot;de&quot;: &quot;USA&quot;,
          &quot;en&quot;: &quot;United States&quot;,
          &quot;es&quot;: &quot;Estados Unidos&quot;,
          &quot;fr&quot;: &quot;États-Unis&quot;,
          &quot;ja&quot;: &quot;アメリカ合衆国&quot;,
          &quot;pt-BR&quot;: &quot;Estados Unidos&quot;,
          &quot;ru&quot;: &quot;США&quot;,
          &quot;zh-CN&quot;: &quot;美国&quot;
        }
      },
      &quot;RepresentedCountry&quot;: {
        &quot;GeoNameID&quot;: 0,
        &quot;IsoCode&quot;: &quot;&quot;,
        &quot;Names&quot;: null,
        &quot;Type&quot;: &quot;&quot;
      },
      &quot;Subdivisions&quot;: null,
      &quot;Traits&quot;: {
        &quot;IsAnonymousProxy&quot;: false,
        &quot;IsSatelliteProvider&quot;: false
      }
    }
  }
}
</code></pre>

<p>Please see the <a href="http://gosparta.io/docs/apigateway/example1">first example</a> for more information on the <code>code</code>, <code>status</code>, and <code>headers</code> keys.</p>

<h1 id="cleaning-up">Cleaning Up</h1>

<p>Before moving on, remember to decommission the service via:</p>

<p><pre><code class="nohighlight">go run main.go delete</code></pre>
</p>

<h1 id="notes">Notes</h1>

<ul>
<li>The <em>GeoLite2-Country.mmdb</em> content is embedded in the go binary via <a href="https://github.com/mjibson/esc">esc</a> as part of the <a href="https://github.com/mweagle/SpartaGeoIP/blob/master/main.go#L27">go generate</a> phase.</li>
<li>This is a port of Tom Maiaroto&rsquo;s <a href="https://github.com/tmaiaroto/go-lambda-geoip">https://github.com/tmaiaroto/go-lambda-geoip</a> implementation.</li>
</ul>

			
				<h1>API Gateway - User Input </h1>

				

<p>This example demonstrates how to accept user input (delivered as HTTP query params) and return an expiring S3 URL to fetch content.  The source for this is the <a href="https://github.com/mweagle/SpartaImager/blob/master/application.go#L149">s3ItemInfo</a> function defined as part of the  <a href="https://github.com/mweagle/SpartaApplication">SpartaApplication</a>.</p>

<h1 id="define-the-lambda-function">Define the Lambda Function</h1>

<p>Our function will accept two params:</p>

<ul>
<li><code>bucketName</code> : The S3 bucket name storing the asset</li>
<li><code>keyName</code> : The S3 item key</li>
</ul>

<p>Those params will be passed as part of the URL query string.  The function will fetch the item metadata, generate an expiring URL for public S3 access, and return a JSON response body with the item data.</p>

<p>Because <a href="https://github.com/mweagle/SpartaImager/blob/master/application.go#L149">s3ItemInfo</a> is expected to be invoked by the API Gateway, we&rsquo;ll start by unmarshalling the event data:</p>

<pre><code class="go">var lambdaEvent sparta.APIGatewayLambdaJSONEvent
err := json.Unmarshal([]byte(*event), &amp;lambdaEvent)
if err != nil {
  logger.Error(&#34;Failed to unmarshal event data: &#34;, err.Error())
  http.Error(w, err.Error(), http.StatusInternalServerError)
  return
}</code></pre>


<p>The <a href="https://godoc.org/github.com/mweagle/Sparta#APIGatewayLambdaJSONEvent">sparta.APIGatewayLambdaJSONEvent</a> fields correspond to the Integration Response Mapping template discussed in the <a href="http://gosparta.io/docs/apigateway/example1">previous example</a> (see the full mapping template <a href="https://raw.githubusercontent.com/mweagle/Sparta/master/resources/gateway/inputmapping_json.vtl">here</a>).</p>

<p>Once the event is unmarshaled, we can use it to fetch the S3 item info:</p>

<pre><code class="go">getObjectInput := &amp;s3.GetObjectInput{
  Bucket: aws.String(lambdaEvent.QueryParams[&#34;bucketName&#34;]),
  Key:    aws.String(lambdaEvent.QueryParams[&#34;keyName&#34;]),
}</code></pre>


<p>Assuming there are no errors (including the case where the item does not exist), the remainder of the function fetches the data, generates a presigned URL, and returns a JSON response:</p>

<pre><code class="go">awsSession := awsSession(logger)
svc := s3.New(awsSession)
result, err := svc.GetObject(getObjectInput)
if nil != err {
  logger.Error(&#34;Failed to process event: &#34;, err.Error())
  http.Error(w, err.Error(), http.StatusInternalServerError)
  return
}
presignedReq, _ := svc.GetObjectRequest(getObjectInput)
url, err := presignedReq.Presign(5 * time.Minute)
if nil != err {
  logger.Error(&#34;Failed to process event: &#34;, err.Error())
  http.Error(w, err.Error(), http.StatusInternalServerError)
  return
}
httpResponse := map[string]interface{}{
  &#34;S3&#34;:  result,
  &#34;URL&#34;: url,
}

responseBody, err := json.Marshal(httpResponse)
if err != nil {
  http.Error(w, err.Error(), http.StatusInternalServerError)
} else {
  w.Header().Set(&#34;Content-Type&#34;, &#34;application/json&#34;)
  fmt.Fprint(w, string(responseBody))
}</code></pre>


<h1 id="create-the-api-gateway">Create the API Gateway</h1>

<p>The next step is to create a new <a href="https://godoc.org/github.com/mweagle/Sparta#API">API</a> instance via <code>sparta.NewAPIGateway()</code></p>

<pre><code class="go">apiStage := sparta.NewStage(&#34;v1&#34;)
apiGateway := sparta.NewAPIGateway(&#34;SpartaImagerAPI&#34;, apiStage)</code></pre>


<h1 id="create-lambda-binding">Create Lambda Binding</h1>

<p>Next we create an <code>sparta.LambdaAWSInfo</code> struct that references the <code>s3ItemInfo</code> function:</p>

<pre><code class="go">s3ItemInfoOptions := &amp;sparta.LambdaFunctionOptions{
  Description: &#34;Get information about an item in S3 via querystring params&#34;,
  MemorySize:  128,
  Timeout:     10,
}
var iamDynamicRole = sparta.IAMRoleDefinition{}
iamDynamicRole.Privileges = append(iamDynamicRole.Privileges, sparta.IAMRolePrivilege{
  Actions:  []string{&#34;s3:GetObject&#34;},
  Resource: resourceArn,
})
s3ItemInfoLambdaFn := sparta.NewLambda(iamDynamicRole, s3ItemInfo, s3ItemInfoOptions)</code></pre>


<p>A few items to note here:</p>

<ul>
<li>We&rsquo;re providing a custom <code>LambdaFunctionOptions</code> in case the request to S3 to get item metadata exceeds the default 3 second timeout.</li>
<li>We also add a custom <code>iamDynamicRole.Privileges</code> entry to the <code>Privileges</code> slice that authorizes the lambda function to <em>only</em> access objects in a single bucket (<em>resourceArn</em>).

<ul>
<li>This bucket ARN is externally created and the ARN provided to this code.</li>
<li>While the API will accept any <em>bucketName</em> value, it is only authorized to access a single bucket.</li>
</ul></li>
</ul>

<h1 id="create-resources">Create Resources</h1>

<p>The next step is to associate a URL path with the <code>sparta.LambdaAWSInfo</code> struct that represents the <code>s3ItemInfo</code> function. This will be the relative path component used to reference our lambda function via the API Gateway.</p>

<pre><code class="go">apiGatewayResource, _ := api.NewResource(&#34;/info&#34;, s3ItemInfoLambdaFn)
method, err := apiGatewayResource.NewMethod(&#34;GET&#34;, http.StatusOK)
if err != nil {
  return nil, err
}</code></pre>


<h1 id="whitelist-input">Whitelist Input</h1>

<p>The final step is to add the whitelisted parameters to the Method definition.</p>

<pre><code class="go">// Whitelist query string params
method.Parameters[&#34;method.request.querystring.keyName&#34;] = true
method.Parameters[&#34;method.request.querystring.bucketName&#34;] = true</code></pre>


<p>Note that the keynames in the <code>method.Parameters</code> map must be of the form: <strong>method.request.{location}.{name}</strong> where location is one of:</p>

<ul>
<li><code>querystring</code></li>
<li><code>path</code></li>
<li><code>header</code></li>
</ul>

<p>See the <a href="http://docs.aws.amazon.com/apigateway/api-reference/resource/method/#requestParameters">REST documentation</a> for more information.</p>

<h1 id="provision">Provision</h1>

<p>With everything configured, let&rsquo;s provision the stack:</p>

<pre><code class="nohighlight">go run application.go --level debug provision --s3Bucket $S3_BUCKET</code></pre>


<p>and check the results.</p>

<h1 id="querying">Querying</h1>

<p>As this Sparta application includes an API Gateway definition, the stack <code>Outputs</code> includes the API Gateway URL:</p>

<pre><code class="nohighlight">INFO[0113] Stack output   Description=API Gateway URL Key=APIGatewayURL Value=https://0ux556ho77.execute-api.us-west-2.amazonaws.com/v1
INFO[0113] Stack output   Description=Sparta Home Key=SpartaHome Value=https://github.com/mweagle/Sparta
INFO[0113] Stack output   Description=Sparta Version Key=SpartaVersion Value=0.1.0</code></pre>


<p>Let&rsquo;s fetch an item we know exists:</p>

<pre><code class="nohighlight">curl -vs &#34;https://0ux556ho77.execute-api.us-west-2.amazonaws.com/v1/info?keyName=gopher.png&amp;bucketName=somebucket-log&#34;

*   Trying 54.192.70.158...
* Connected to 0ux556ho77.execute-api.us-west-2.amazonaws.com (54.192.70.158) port 443 (#0)
* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate: *.execute-api.us-west-2.amazonaws.com
* Server certificate: Symantec Class 3 Secure Server CA - G4
* Server certificate: VeriSign Class 3 Public Primary Certification Authority - G5
&gt; GET /v1/info?keyName=gopher.png&amp;bucketName=somebucket-log HTTP/1.1
&gt; Host: 0ux556ho77.execute-api.us-west-2.amazonaws.com
&gt; User-Agent: curl/7.43.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Content-Type: application/json
&lt; Content-Length: 1584
&lt; Connection: keep-alive
&lt; Date: Sun, 06 Dec 2015 02:35:03 GMT
&lt; x-amzn-RequestId: f333f4bb-9bc1-11e5-afde-61a428c89049
&lt; X-Cache: Miss from cloudfront
&lt; Via: 1.1 2f31d4850470c56c3b326946dc542a6b.cloudfront.net (CloudFront)
&lt; X-Amz-Cf-Id: 6rBpqjmi7DPax7XOHTbxDx8-FfFfvI04m2_K-PxLWfYFor7WtIcdxA==
&lt;
* Connection #0 to host 0ux556ho77.execute-api.us-west-2.amazonaws.com left intact
{&#34;code&#34;:200,&#34;status&#34;:&#34;OK&#34;,&#34;headers&#34;:{&#34;content-type&#34;:&#34;application/json&#34;,&#34;date&#34;:&#34;Sun, 06 Dec 2015 02:35:03 GMT&#34;,&#34;content-length&#34;:&#34;1468&#34;},&#34;results&#34;:{&#34;S3&#34;:{&#34;AcceptRanges&#34;:&#34;bytes&#34;,&#34;Body&#34;:{},&#34;CacheControl&#34;:null,&#34;ContentDisposition&#34;:null,&#34;ContentEncoding&#34;:null,&#34;ContentLanguage&#34;:null,&#34;ContentLength&#34;:70372,&#34;ContentRange&#34;:null,&#34;ContentType&#34;:&#34;image/png&#34;,&#34;DeleteMarker&#34;:null,&#34;ETag&#34;:&#34;\&#34;ca1f746d6f232f87fca4e4d94ef6f3ab\&#34;&#34;,&#34;Expiration&#34;:null,&#34;Expires&#34;:null,&#34;LastModified&#34;:&#34;2015-11-09T15:38:01Z&#34;,&#34;Metadata&#34;:{},&#34;MissingMeta&#34;:null,&#34;ReplicationStatus&#34;:null,&#34;RequestCharged&#34;:null,&#34;Restore&#34;:null,&#34;SSECustomerAlgorithm&#34;:null,&#34;SSECustomerKeyMD5&#34;:null,&#34;SSEKMSKeyId&#34;:null,&#34;ServerSideEncryption&#34;:null,&#34;StorageClass&#34;:null,&#34;VersionId&#34;:null,&#34;WebsiteRedirectLocation&#34;:null},&#34;URL&#34;:&#34;https://somebucket-log.s3-us-west-2.amazonaws.com/gopher.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAJ5KB2P6SQ4E7IMMQ%2F20151206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20151206T023503Z&amp;X-Amz-Expires=300&amp;X-Amz-Security-Token=AQoDYXdzEFQawAK7vrGb%2BH9lw%2FhEHpR9Yg1KwPmmFcvyMzF7ewFBmxpOkfEM7gLZirMcFFexcxpWv%2F5CVAxpqjRf5FznOYJZHHoBqgmUcKPQZOpYKSbQG768zH5gMNdOANWin1COZU8DyuABrkJYL1bdFpwV7oHgrDmRz2G6oZqqOnfesRHW8WcehSXMV%2BcQFaAcO7IaIMAkRINMIDfxQaa%2FP8i8dbrcOfsEy6UABeaLKL3YgdZIouxcUUKzXQ6Pr4Cgrf0TAyRDAO1t6bVXzv6UFa6j00%2Fm0PYElni7xs5844UFAav%2B1weO2kX65ETzwUxBacAAnuzt%2BmTVPWeikhzgRnjBFn8mQjkZLCJklJJb6QHBO8dph2CSQsh47yw7%2BnexGjAu1y106AA2%2Bfa0WFYC552Q%2FrVVhKU7dejy%2B3jz%2F4LyWdnva9IvmCDVvY6zBQ%3D%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=7d0e6663e043317b5611ddf4ae9f7514aff8c484a31deba524906ba50cbc6a2f&#34;}}</code></pre>


<p>Pretty printing the response body:</p>

<pre><code class="json">{
  &#34;code&#34;: 200,
  &#34;status&#34;: &#34;OK&#34;,
  &#34;headers&#34;: {
    &#34;content-type&#34;: &#34;application/json&#34;,
    &#34;date&#34;: &#34;Sun, 06 Dec 2015 02:35:03 GMT&#34;,
    &#34;content-length&#34;: &#34;1468&#34;
  },
  &#34;results&#34;: {
    &#34;S3&#34;: {
      &#34;AcceptRanges&#34;: &#34;bytes&#34;,
      &#34;Body&#34;: {},
      &#34;CacheControl&#34;: null,
      &#34;ContentDisposition&#34;: null,
      &#34;ContentEncoding&#34;: null,
      &#34;ContentLanguage&#34;: null,
      &#34;ContentLength&#34;: 70372,
      &#34;ContentRange&#34;: null,
      &#34;ContentType&#34;: &#34;image/png&#34;,
      &#34;DeleteMarker&#34;: null,
      &#34;ETag&#34;: &#34;\&#34;ca1f746d6f232f87fca4e4d94ef6f3ab\&#34;&#34;,
      &#34;Expiration&#34;: null,
      &#34;Expires&#34;: null,
      &#34;LastModified&#34;: &#34;2015-11-09T15:38:01Z&#34;,
      &#34;Metadata&#34;: {},
      &#34;MissingMeta&#34;: null,
      &#34;ReplicationStatus&#34;: null,
      &#34;RequestCharged&#34;: null,
      &#34;Restore&#34;: null,
      &#34;SSECustomerAlgorithm&#34;: null,
      &#34;SSECustomerKeyMD5&#34;: null,
      &#34;SSEKMSKeyId&#34;: null,
      &#34;ServerSideEncryption&#34;: null,
      &#34;StorageClass&#34;: null,
      &#34;VersionId&#34;: null,
      &#34;WebsiteRedirectLocation&#34;: null
    },
    &#34;URL&#34;: &#34;https://somebucket-log.s3-us-west-2.amazonaws.com/gopher.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAJ5KB2P6SQ4E7IMMQ%2F20151206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20151206T023503Z&amp;X-Amz-Expires=300&amp;X-Amz-Security-Token=AQoDYXdzEFQawAK7vrGb%2BH9lw%2FhEHpR9Yg1KwPmmFcvyMzF7ewFBmxpOkfEM7gLZirMcFFexcxpWv%2F5CVAxpqjRf5FznOYJZHHoBqgmUcKPQZOpYKSbQG768zH5gMNdOANWin1COZU8DyuABrkJYL1bdFpwV7oHgrDmRz2G6oZqqOnfesRHW8WcehSXMV%2BcQFaAcO7IaIMAkRINMIDfxQaa%2FP8i8dbrcOfsEy6UABeaLKL3YgdZIouxcUUKzXQ6Pr4Cgrf0TAyRDAO1t6bVXzv6UFa6j00%2Fm0PYElni7xs5844UFAav%2B1weO2kX65ETzwUxBacAAnuzt%2BmTVPWeikhzgRnjBFn8mQjkZLCJklJJb6QHBO8dph2CSQsh47yw7%2BnexGjAu1y106AA2%2Bfa0WFYC552Q%2FrVVhKU7dejy%2B3jz%2F4LyWdnva9IvmCDVvY6zBQ%3D%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=7d0e6663e043317b5611ddf4ae9f7514aff8c484a31deba524906ba50cbc6a2f&#34;
  }
}</code></pre>


<p>Please see the <a href="http://gosparta.io/docs/apigateway/example1">first example</a> for more information on the <code>code</code>, <code>status</code>, and <code>headers</code> keys.</p>

<p>What about an item that we know doesn&rsquo;t exist, but is in the bucket our lambda function has privileges to access:</p>

<pre><code class="nohighlight">curl -vs &#34;https://0ux556ho77.execute-api.us-west-2.amazonaws.com/v1/info?keyName=gopher42.png&amp;bucketName=somebucket-log&#34;

*   Trying 54.230.71.213...
* Connected to 0ux556ho77.execute-api.us-west-2.amazonaws.com (54.230.71.213) port 443 (#0)
* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate: *.execute-api.us-west-2.amazonaws.com
* Server certificate: Symantec Class 3 Secure Server CA - G4
* Server certificate: VeriSign Class 3 Public Primary Certification Authority - G5
&gt; GET /v1/info?keyName=gopher42.png&amp;bucketName=somebucket-log HTTP/1.1
&gt; Host: 0ux556ho77.execute-api.us-west-2.amazonaws.com
&gt; User-Agent: curl/7.43.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 500 Internal Server Error
&lt; Content-Type: application/json
&lt; Content-Length: 524
&lt; Connection: keep-alive
&lt; Date: Sun, 06 Dec 2015 02:40:14 GMT
&lt; x-amzn-RequestId: ad5d94eb-9bc2-11e5-8fad-476a6cacabce
&lt; X-Cache: Error from cloudfront
&lt; Via: 1.1 29bfa9b96f4ea66dc02526ee845ca6b0.cloudfront.net (CloudFront)
&lt; X-Amz-Cf-Id: XoVLBjm1dgozZsNAEGk8Vy_a5PXMYNWRD6eKJJBcVTXrtMgMhiLNyQ==
&lt;
* Connection #0 to host 0ux556ho77.execute-api.us-west-2.amazonaws.com left intact
{&#34;errorMessage&#34;:&#34;{\&#34;code\&#34;:500,\&#34;status\&#34;:\&#34;Internal Server Error\&#34;,\&#34;headers\&#34;:{\&#34;content-type\&#34;:\&#34;text/plain; charset=utf-8\&#34;,\&#34;x-content-type-options\&#34;:\&#34;nosniff\&#34;,\&#34;date\&#34;:\&#34;Sun, 06 Dec 2015 02:40:14 GMT\&#34;,\&#34;content-length\&#34;:\&#34;60\&#34;},\&#34;error\&#34;:\&#34;AccessDenied: Access Denied\\n\\tstatus code: 403, request id: \\n\&#34;}&#34;,&#34;errorType&#34;:&#34;Error&#34;,&#34;stackTrace&#34;:[&#34;IncomingMessage.&lt;anonymous&gt; (/var/task/index.js:68:53)&#34;,&#34;IncomingMessage.emit (events.js:117:20)&#34;,&#34;_stream_readable.js:944:16&#34;,&#34;process._tickCallback (node.js:442:13)&#34;]}</code></pre>


<p>And finally, what if we try to access a bucket that our lambda function isn&rsquo;t authorized to access:</p>

<pre><code class="nohighlight">curl -vs &#34;https://0ux556ho77.execute-api.us-west-2.amazonaws.com/v1/info?keyName=gopher.png&amp;bucketName=weagle&#34;

*   Trying 54.192.70.129...
* Connected to 0ux556ho77.execute-api.us-west-2.amazonaws.com (54.192.70.129) port 443 (#0)
* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate: *.execute-api.us-west-2.amazonaws.com
* Server certificate: Symantec Class 3 Secure Server CA - G4
* Server certificate: VeriSign Class 3 Public Primary Certification Authority - G5
&gt; GET /v1/info?keyName=gopher.png&amp;bucketName=weagle HTTP/1.1
&gt; Host: 0ux556ho77.execute-api.us-west-2.amazonaws.com
&gt; User-Agent: curl/7.43.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 500 Internal Server Error
&lt; Content-Type: application/json
&lt; Content-Length: 524
&lt; Connection: keep-alive
&lt; Date: Sun, 06 Dec 2015 02:42:52 GMT
&lt; x-amzn-RequestId: 0be0fc4f-9bc3-11e5-b827-81d99c02192f
&lt; X-Cache: Error from cloudfront
&lt; Via: 1.1 400bdbea4e851ce61e7df8252da93d3f.cloudfront.net (CloudFront)
&lt; X-Amz-Cf-Id: M_7pB1UsW63xzh_9g37-CqNYDXfXlec0B6DV4bdkq3tbCANCOrTY6Q==
&lt;
* Connection #0 to host 0ux556ho77.execute-api.us-west-2.amazonaws.com left intact
{&#34;errorMessage&#34;:&#34;{\&#34;code\&#34;:500,\&#34;status\&#34;:\&#34;Internal Server Error\&#34;,\&#34;headers\&#34;:{\&#34;content-type\&#34;:\&#34;text/plain; charset=utf-8\&#34;,\&#34;x-content-type-options\&#34;:\&#34;nosniff\&#34;,\&#34;date\&#34;:\&#34;Sun, 06 Dec 2015 02:42:52 GMT\&#34;,\&#34;content-length\&#34;:\&#34;60\&#34;},\&#34;error\&#34;:\&#34;AccessDenied: Access Denied\\n\\tstatus code: 403, request id: \\n\&#34;}&#34;,&#34;errorType&#34;:&#34;Error&#34;,&#34;stackTrace&#34;:[&#34;IncomingMessage.&lt;anonymous&gt; (/var/task/index.js:68:53)&#34;,&#34;IncomingMessage.emit (events.js:117:20)&#34;,&#34;_stream_readable.js:944:16&#34;,&#34;process._tickCallback (node.js:442:13)&#34;]}</code></pre>


<h1 id="cleaning-up">Cleaning Up</h1>

<p>Before moving on, remember to decommission the service via:</p>

<pre><code class="nohighlight">go run application.go delete</code></pre>


<h1 id="wrapping-up">Wrapping Up</h1>

<p>With this example we&rsquo;ve walked through a simple example that whitelists user input, uses IAM Roles to limit what S3 buckets a lambda function may access, and returns JSON data to the caller.</p>

			
				<h1>Application Customization </h1>

				

<h2 id="customization-options">Customization Options</h2>

<p>Sparta-based applications use the <a href="https://github.com/spf13/cobra">Cobra</a> package to expose a rich set of command line options.  This section describes:</p>

<ul>
<li><a href="http://gosparta.io/docs/application/commandline">Default options</a></li>
<li><a href="http://gosparta.io/docs/application/custom_flags">Adding flags</a></li>
<li><a href="http://gosparta.io/docs/application/custom_commands">Adding commands</a></li>
<li><a href="http://gosparta.io/docs/application/environments">Managing Environments</a></li>
<li><a href="http://gosparta.io/docs/application/workflow_hooks">Workflow Hooks</a></li>
</ul>

<p>Adding custom flags or commands is typically a prerequisite to supporting <a href="http://gosparta.io/docs/alternative_topologies">alternative topologies</a>.</p>

			
				<h1>Event Sources </h1>

				<p>The true power of the AWS Lambda architecture is the ability to integrate Lambda execution with other AWS service state transitions.  Depending on the service type, state change events are either pushed or transparently polled and used as the input to a Lambda execution.</p>

<p>There are several <a href="http://docs.aws.amazon.com/lambda/latest/dg/intro-core-components.html">event sources</a> available.  They are grouped into Pull and Push types.  Pull based models use <code>sparta.EventSourceMapping</code> values, as the trigger configuration is stored in the AWS Lambda service.  Push based types use service specific <code>sparta.*Permission</code> types to denote the fact that the trigger logic is configured in the remote service.</p>

<ul>
<li>Pull Based

<ul>
<li><a href="http://gosparta.io/docs/eventsources/dynamodb">DynamoDB</a></li>
<li><a href="http://gosparta.io/docs/eventsources/kinesis">Kinesis</a></li>
</ul></li>
<li>Pushed Based

<ul>
<li><a href="http://gosparta.io/docs/eventsources/cloudformation">CloudFormation</a> <span class="label label-warning">NOT YET IMPLEMENTED</span></li>
<li><a href="http://gosparta.io/docs/eventsources/cloudwatchevents">CloudWatch Events</a></li>
<li><a href="http://gosparta.io/docs/eventsources/cloudwatchlogs">CloudWatch Logs</a></li>
<li><a href="http://gosparta.io/docs/eventsources/cognito">Cognito</a> <span class="label label-warning">NOT YET IMPLEMENTED</span></li>
<li><a href="http://gosparta.io/docs/eventsources/s3">S3</a></li>
<li><a href="http://gosparta.io/docs/eventsources/ses">SES</a></li>
<li><a href="http://gosparta.io/docs/eventsources/sns">SNS</a></li>
</ul></li>
</ul>

			
				<h1>Sparta </h1>

				

<p><br />
<img src="http://gosparta.io/images/SpartaLogoNoDomain.png" alt="Sparta shield" height="128">
<br /></p>

<p>A <b>Go</b> framework for <a href="https://aws.amazon.com/lambda">AWS Lambda</a> microservices
<br /></p>

<table style="width:90%">
  <!-- Row 1 -->
  <tr>
    <td style="width:50%">
      <h2>Unified Language</h2>
      <p>Use a single <b>Go</b> codebase to define your microservice's:
      <ul>
        <li>Application logic</li>
        <li>AWS infrastructure</li>
        <li>Operational metrics</li>
        <li>Alert conditions</li>
        <li>Security policies</li>
      </ul>
    </td>
    <td style="width:50%">
      <h2>Complete AWS Ecosystem</h2>
      <p>Sparta enables your lambda-based service to seamlessly integrate with the entire set of AWS lambda <a href="http://docs.aws.amazon.com/lambda/latest/dg/intro-core-components.html">event sources</a> such as:
        <ul>
          <li>DynamoDB</li>
          <li>S3</li>
          <li>Kinesis</li>
          <li>SNS</li>
          <li>SES</li>
          <li>CloudWatch Events</li>
          <li>CloudWatch Logs</li>
        </ul>
        Additionally, your service may provision any other <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html">CloudFormation</a> supported resource and even your own <a href="http://gosparta.io/docs/custom_resources">CustomResources</a>.
        </p>
    </td>
  </tr>
  <!-- Row 2 -->
  <tr>
    <td style="width:50%">
      <h2>Security</h2>
      <p>Define <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies.html">IAM Roles</a> with limited privileges to minimize your service's attack surface.  Both string literal and ARN expressions are supported in order to reference dynamically created resources.  Sparta treats <a href="http://searchsecurity.techtarget.com/definition/principle-of-least-privilege-POLP">POLP</a> and <a href="https://twitter.com/hashtag/secops">#SecOps</a> as first-class goals.
      </p>
    </td>
    <td style="width:50%">
      <h2>Discovery</h2>
      <p>A service may provision dynamic AWS infrastructure, and <a href="http://gosparta.io/docs/eventsources">discover</a>, at lambda execution time, the dependent resources' AWS-assigned outputs (<code>Ref</code> &amp; <code>Fn::Att</code>).  Eliminate hardcoded <i>Magic ARNs</i> from your codebase and move towards <a href="http://chadfowler.com/2013/06/23/immutable-deployments.html">immutable infrastructure</a></p>
    </td>
  </tr>
  <!-- Row 3 -->
  <tr>
    <td style="width:50%">
      <h2>API Gateway</h2>
      <p>Make your service HTTPS accessible by binding it to an <a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/welcome.html">API Gateway</a> REST API during provisioning.  As part of API Gateway creation, Sparta includes <a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html">API Gateway Mapping Templates</a> with all request data, including user-defined whitelisted parameters, so that you can focus on your core application logic.</p>
    </td>
    <td style="width:50%">
      <h2>Static Sites</h2>
      <p>Include a <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html">CORS-enabled</a> <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html">S3-backed site</a> with your service.  S3-backed sites include API Gateway discovery information for turnkey deployment.</p>
    </td>
  </tr>
</table>

<hr />

<p><a href="https://cloudcraft.co/view/8571b3bc-76ef-48c1-8401-0b6ae1d36b4e?key=d44zi4j1pxj00000" rel="Sparta Arch"><img src="http://gosparta.io/images/sparta_overview.png" alt="Sparta Overview" /></a></p>

<p>Sparta exclusively relies on <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html">CloudFormation</a> to deploy and update your application.  For resources that CloudFormation does not yet support, it uses <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html">Lambda-backed Custom Resources</a> so that all service updates support both update and rollback semantics.  Sparta&rsquo;s automatically generated CloudFormation resources use content-based logical IDs whenever possible to preserve <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks.html">service availability</a> during updates.</p>

<h1 id="hello-lambda-world">Hello Lambda World</h1>

<pre><code class="go">// File: application.go
package main

import (
	&#34;encoding/json&#34;
	&#34;fmt&#34;
	&#34;net/http&#34;

	&#34;github.com/Sirupsen/logrus&#34;
	sparta &#34;github.com/mweagle/Sparta&#34;
)

////////////////////////////////////////////////////////////////////////////////
// Hello world event handler
//
func helloWorld(event *json.RawMessage,
              	context *sparta.LambdaContext,
              	w http.ResponseWriter,
              	logger *logrus.Logger) {
	logger.Info(&#34;Hello World: &#34;, string(*event))
	fmt.Fprint(w, string(*event))
}

////////////////////////////////////////////////////////////////////////////////
// Main
func main() {
  var lambdaFunctions []*sparta.LambdaAWSInfo
  lambdaFn := sparta.NewLambda(sparta.IAMRoleDefinition{}, helloWorld, nil)
  lambdaFunctions = append(lambdaFunctions, lambdaFn)

  // Deploy it
  sparta.Main(&#34;SpartaHelloWorld&#34;,
		&#34;Simple Sparta application that creates a single AWS Lambda function&#34;,
		lambdaFunctions,
                nil,
                nil)
}</code></pre>


<h1 id="getting-started">Getting Started</h1>

<p>To get started using Sparta, begin with the <a href="http://gosparta.io/docs/overview">Documentation</a>.</p>

<h1 id="administration">Administration</h1>

<ul>
<li>Problems?  Please open an <a href="https://github.com/mweagle/Sparta/issues/new">issue</a> in GitHub.</li>
<li>See <a href="https://trello.com/b/WslDce70/sparta">Trello</a> for the Sparta backlog.</li>
</ul>

<h1 id="questions">Questions?</h1>

<p>Get in touch via:</p>

<ul>
<li><i class="fa fa-twitter">&nbsp; @mweagle</i></li>
<li><i class="fa fa-slack">&nbsp; Gophers: <a href="https://gophers.slack.com/team/mweagle">@mweagle</a></i>

<ul>
<li><a href="https://invite.slack.golangbridge.org/">Signup page</a></li>
</ul></li>
<li><i class="fa fa-slack">&nbsp; Serverless: <a href="https://serverless-forum.slack.com/team/mweagle">@mweagle</a></i>

<ul>
<li><a href="https://wt-serverless-seattle.run.webtask.io/serverless-forum-signup?webtask_no_cache=1">Signup page</a></li>
</ul></li>
</ul>

<h2 id="other-resources">Other resources</h2>

<ul>
<li><a href="https://medium.com/@mweagle/a-go-framework-for-aws-lambda-ab14f0c42cb#.6gtlwe5vg">Sparta - A Go framework for AWS Lambda</a></li>
<li>Other libraries &amp; frameworks:

<ul>
<li><a href="https://github.com/serverless/serverless">Serverless</a></li>
<li><a href="https://github.com/braahyan/PAWS">PAWS</a></li>
<li><a href="http://apex.run">Apex</a></li>
<li><a href="https://github.com/jasonmoo/lambda_proc">lambda_proc</a></li>
<li><a href="https://github.com/xlab/go-lambda">go-lambda</a></li>
<li><a href="https://github.com/pilwon/go-lambda">go-lambda (GRPC)</a></li>
</ul></li>
<li>Supported AWS Lambda <a href="http://docs.aws.amazon.com/lambda/latest/dg/programming-model-v2.html">programming models</a></li>
<li><a href="https://serverlesscode.com">Serverless Code Blog</a></li>
<li><a href="https://d0.awsstatic.com/whitepapers/AWS_Serverless_Multi-Tier_Architectures.pdf">AWS Serverless Multi-Tier Architectures Whitepaper</a></li>
<li><a href="http://docs.aws.amazon.com/lambda/latest/dg/limits.html">Lambda limits</a></li>
<li><a href="https://aws.amazon.com/blogs/compute/the-twelve-days-of-lambda/">The Twelve Days of Lambda</a></li>
<li><a href="http://cloudcraft.co">CloudCraft</a> is a great tool for AWS architecture diagrams</li>
</ul>

			

			<aside class="copyright" role="note">
				
				&copy; 2017 Copyright 2015-2017 Matt Weagle &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				



<nav class="pagination" aria-label="Footer">
  <div class="previous">
  </div>

  
  
  <div class="next">
      <a href="http://gosparta.io/tags/" title="Tags">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Tags
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  </div>
</nav>



			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>


    <script>
    
      var base_url = 'http:\/\/gosparta.io\/';
      var repo_id  = 'mweagle\/Sparta';
    
    </script>

    <script src="http://gosparta.io/javascripts/application.js"></script>
    
    <script src="http://gosparta.io/mermaid_dist/mermaid.min.js"></script>
    
    <script src="http://gosparta.io/jquery/jquery-2.2.0.min.js"></script>
    

    
    <script>mermaid.initialize({startOnLoad:true});</script>


    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-70794971-1', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
         
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

