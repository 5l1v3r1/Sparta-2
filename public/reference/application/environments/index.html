<!DOCTYPE html>
<html>
  <head>
    <title>Sparta Documentation</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="generator" content="Hugo 0.40.3" />
<title>Managing Environments :: Sparta Documentation</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/theme-flex/style.css" rel="stylesheet">

<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "\/";
</script>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70794971-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70794971-2');
</script>

<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png">
<meta name="description" content="">



<style>
  article section.page code {
      font-family:  monospace; }
</style>

    
  </head>
  <body data-url="/reference/application/environments/">
    
      <header>
  <div class="logo">
    
	
  
    <p><img src="/images/SpartaLogoNoDomain.png" alt="Sparta" title="Sparta" /></p>

  

  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
    <nav class="shortcuts">
            <li class="" role="">
                <a href="/credits"  rel="noopener">
                  <i class='fa fa-bullhorn'></i> <label>Credits</label>
                </a>
            </li>
            <li class="" role="">
                <a href="https://github.com/mweagle/Sparta"  rel="noopener">
                  <i class='fa fa-github'></i> <label>Github</label>
                </a>
            </li>
    </nav>
</header>
<article>
  <aside>
    <ul class="menu">
          <li data-nav-id="/" class="dd-item">
          <a href="/">
            <i class="fa fa-fw fa-home"></i>
          </a>
          </li>
    <li data-nav-id="/overview/" class="dd-item alwaysopen
        ">
      <div>
      <a href="/overview/">Overview</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>
    <li data-nav-id="/sample_service/" class="dd-item haschildren
        ">
      <div>
      <a href="/sample_service/">Sample Service</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/sample_service/step1/" class="dd-item">
        <div>
          <a href="/sample_service/step1/">
            Overview
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/sample_service/step2/" class="dd-item">
        <div>
          <a href="/sample_service/step2/">
            Details
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/reference/" class="dd-item parent alwaysopen haschildren
        ">
      <div>
      <a href="/reference/">Reference</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/reference/eventsources/" class="dd-item haschildren
        ">
      <div>
      <a href="/reference/eventsources/">Event Sources</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/reference/eventsources/cloudformation/" class="dd-item">
        <div>
          <a href="/reference/eventsources/cloudformation/">
            CloudFormation
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/eventsources/cloudwatchevents/" class="dd-item">
        <div>
          <a href="/reference/eventsources/cloudwatchevents/">
            CloudWatch Events
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/eventsources/cloudwatchlogs/" class="dd-item">
        <div>
          <a href="/reference/eventsources/cloudwatchlogs/">
            CloudWatch Logs
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/eventsources/cognito/" class="dd-item">
        <div>
          <a href="/reference/eventsources/cognito/">
            Cognito
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/eventsources/dynamodb/" class="dd-item">
        <div>
          <a href="/reference/eventsources/dynamodb/">
            DynamoDB
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/eventsources/kinesis/" class="dd-item">
        <div>
          <a href="/reference/eventsources/kinesis/">
            Event Sources - Kinesis
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/eventsources/s3/" class="dd-item">
        <div>
          <a href="/reference/eventsources/s3/">
            S3
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/eventsources/ses/" class="dd-item">
        <div>
          <a href="/reference/eventsources/ses/">
            SES
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/eventsources/sns/" class="dd-item">
        <div>
          <a href="/reference/eventsources/sns/">
            SNS
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/reference/apigateway/" class="dd-item haschildren
        ">
      <div>
      <a href="/reference/apigateway/">API Gateway</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/reference/apigateway/echo_event/" class="dd-item">
        <div>
          <a href="/reference/apigateway/echo_event/">
            Echo Event
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/apigateway/user_input/" class="dd-item">
        <div>
          <a href="/reference/apigateway/user_input/">
            User Input
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/apigateway/context/" class="dd-item">
        <div>
          <a href="/reference/apigateway/context/">
            Request Context
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/apigateway/cors/" class="dd-item">
        <div>
          <a href="/reference/apigateway/cors/">
            CORS
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/apigateway/slack/" class="dd-item">
        <div>
          <a href="/reference/apigateway/slack/">
            Slack SlashCommand
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/reference/application/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/reference/application/">Application Customization</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/reference/application/commandline/" class="dd-item">
        <div>
          <a href="/reference/application/commandline/">
            Command Line Options
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/application/custom_commands/" class="dd-item">
        <div>
          <a href="/reference/application/custom_commands/">
            Custom Application Commands
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/application/custom_flags/" class="dd-item">
        <div>
          <a href="/reference/application/custom_flags/">
            Custom Flags
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/application/environments/" class="dd-item active">
        <div>
          <a href="/reference/application/environments/">
            Managing Environments
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/application/workflow_hooks/" class="dd-item">
        <div>
          <a href="/reference/application/workflow_hooks/">
            Workflow Hooks
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
      <li data-nav-id="/reference/cicd/" class="dd-item">
        <div>
          <a href="/reference/cicd/">
            CI/CD
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/custom_resources/" class="dd-item">
        <div>
          <a href="/reference/custom_resources/">
            Custom Resources
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/deployment_strategies/" class="dd-item">
        <div>
          <a href="/reference/deployment_strategies/">
            Deployment Strategies
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/discovery/" class="dd-item">
        <div>
          <a href="/reference/discovery/">
            Discovery Service
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/docker/" class="dd-item">
        <div>
          <a href="/reference/docker/">
            Docker
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/dynamic_infrastructure/" class="dd-item">
        <div>
          <a href="/reference/dynamic_infrastructure/">
            Dynamic Infrastructure
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/hybrid_topologies/" class="dd-item">
        <div>
          <a href="/reference/hybrid_topologies/">
            Hybrid Topologies
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/local_testing/" class="dd-item">
        <div>
          <a href="/reference/local_testing/">
            Local Testing
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/profiling/" class="dd-item">
        <div>
          <a href="/reference/profiling/">
            Profiling
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/s3site/" class="dd-item">
        <div>
          <a href="/reference/s3site/">
            S3 Sites with CORS
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/step_functions/" class="dd-item">
        <div>
          <a href="/reference/step_functions/">
            Step Functions
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/limitations/" class="dd-item">
        <div>
          <a href="/reference/limitations/">
            Limitations
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/reference/faq/" class="dd-item">
        <div>
          <a href="/reference/faq/">
            FAQ
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/presentations/" class="dd-item
        ">
      <div>
      <a href="/presentations/">Presentations</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>
    <li data-nav-id="/credits/" class="dd-item
        ">
      <div>
      <a href="/credits/">Credits</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>
    <li data-nav-id="/meta/" class="dd-item
        ">
      <div>
      <a href="/meta/">_meta</a><i class="fa fa-circle-thin read-icon"></i>
      </div>
    </li>




    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/overview/" >
   Overview</option> 
  
    <option value="/sample_service/" >
   Sample Service</option>
    <option value="/reference/" >
   Reference</option> 
    <option value="/reference/eventsources/" >
  - 
   Event Sources</option>
    <option value="/reference/apigateway/" >
  - 
   API Gateway</option>
    <option value="/reference/application/" >
  - 
   Application Customization</option> 
      <option value="/reference/application/commandline/" >-- Command Line Options</option>
      <option value="/reference/application/custom_commands/" >-- Custom Application Commands</option>
      <option value="/reference/application/custom_flags/" >-- Custom Flags</option>
      <option value="/reference/application/environments/"  selected>-- Managing Environments</option>
      <option value="/reference/application/workflow_hooks/" >-- Workflow Hooks</option>
  
      <option value="/reference/cicd/" >- CI/CD</option>
      <option value="/reference/custom_resources/" >- Custom Resources</option>
      <option value="/reference/deployment_strategies/" >- Deployment Strategies</option>
      <option value="/reference/discovery/" >- Discovery Service</option>
      <option value="/reference/docker/" >- Docker</option>
      <option value="/reference/dynamic_infrastructure/" >- Dynamic Infrastructure</option>
      <option value="/reference/hybrid_topologies/" >- Hybrid Topologies</option>
      <option value="/reference/local_testing/" >- Local Testing</option>
      <option value="/reference/profiling/" >- Profiling</option>
      <option value="/reference/s3site/" >- S3 Sites with CORS</option>
      <option value="/reference/step_functions/" >- Step Functions</option>
      <option value="/reference/limitations/" >- Limitations</option>
      <option value="/reference/faq/" >- FAQ</option>
  
    <option value="/presentations/" >
   Presentations</option>
    <option value="/credits/" >
   Credits</option>
    <option value="/meta/" >
   _meta</option>



        </select>
      </center>
    </div>
      <div>
        <div class="searchbox">
          <input data-search-input id="search-by" type="text" placeholder="Search...">
        </div>
        <script type="text/javascript" src="/js/lunr.min.js"></script>
        <script type="text/javascript" src="/js/auto-complete.js"></script>
        <link href="/css/auto-complete.css" rel="stylesheet">
        <script type="text/javascript">
          
              var baseurl = "\/";
          
        </script>
        <script type="text/javascript" src="/js/search.js"></script>
      </div>
    

    <h1>Managing Environments</h1>
    
    
    
    

<h1 id="introduction">Introduction</h1>

<p>It&rsquo;s common for a single Sparta application to target multiple <em>environments</em>. For example:</p>

<ul>
<li>Development</li>
<li>Staging</li>
<li>Production</li>
</ul>

<p>Each environment is largely similar, but the application may need slightly different configuration in each context.</p>

<p>To support this, Sparta uses Go&rsquo;s <a href="http://dave.cheney.net/2013/10/12/how-to-use-conditional-compilation-with-the-go-build-tool">conditional compliation</a> support to ensure that configuration information is validated at build time.  Conditional compilation is supported via the <code>--tags/-t</code> command line argument.</p>

<p>This example will work through the <a href="https://github.com/mweagle/SpartaConfig">SpartaConfig</a> sample. The requirement is that each environment declare it&rsquo;s <code>Name</code> and also add that value as a Stack <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html">Output</a>.</p>

<h2 id="default-configuration">Default Configuration</h2>

<p>To start with, create the <em>default</em> configuration. This is the configuration that Sparta uses when provisioning your Stack and defines the environment configuration contract.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8f5902;font-style:italic">// +build !staging,!production
</span><span style="color:#8f5902;font-style:italic">// file: environments/default.go
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">environments</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
	<span style="color:#4e9a06">&#34;fmt&#34;</span>
	<span style="color:#4e9a06">&#34;github.com/Sirupsen/logrus&#34;</span>
	<span style="color:#4e9a06">&#34;github.com/aws/aws-sdk-go/aws/session&#34;</span>
	<span style="color:#000">gocf</span> <span style="color:#4e9a06">&#34;github.com/crewjam/go-cloudformation&#34;</span>
	<span style="color:#000">sparta</span> <span style="color:#4e9a06">&#34;github.com/mweagle/Sparta&#34;</span>
<span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic">// Name is the default configuration
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span></code></pre></div>
<p>The important part is the set of excluded tags at the top of the file:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">build</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">staging</span><span style="color:#000;font-weight:bold">,!</span><span style="color:#000">production</span></code></pre></div>
<p>This ensures that the configuration is only eligible for compilation when Sparta goes to <code>provision</code> the service.</p>

<h2 id="environment-configuration">Environment Configuration</h2>

<p>The next steps are to define the environment-specific configuration files:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8f5902;font-style:italic">// +build staging
</span><span style="color:#8f5902;font-style:italic">// file: environments/staging.go
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">environments</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
	<span style="color:#4e9a06">&#34;github.com/Sirupsen/logrus&#34;</span>
	<span style="color:#4e9a06">&#34;github.com/aws/aws-sdk-go/aws/session&#34;</span>
	<span style="color:#000">gocf</span> <span style="color:#4e9a06">&#34;github.com/crewjam/go-cloudformation&#34;</span>
	<span style="color:#000">sparta</span> <span style="color:#4e9a06">&#34;github.com/mweagle/Sparta&#34;</span>
<span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic">// Name is the production configuration
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;staging&#34;</span></code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#8f5902;font-style:italic">// +build production
</span><span style="color:#8f5902;font-style:italic">// file: environments/production.go
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">environments</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
	<span style="color:#4e9a06">&#34;github.com/Sirupsen/logrus&#34;</span>
	<span style="color:#4e9a06">&#34;github.com/aws/aws-sdk-go/aws/session&#34;</span>
	<span style="color:#000">gocf</span> <span style="color:#4e9a06">&#34;github.com/crewjam/go-cloudformation&#34;</span>
	<span style="color:#000">sparta</span> <span style="color:#4e9a06">&#34;github.com/mweagle/Sparta&#34;</span>
<span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic">// Name is the production configuration
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;production&#34;</span></code></pre></div>
<p>These three files define the set of compile-time mutually-exclusive sources that represent environment targets.</p>

<h2 id="segregating-services">Segregating Services</h2>

<p>The <code>serviceName</code> argument supplied to <a href="https://godoc.org/github.com/mweagle/Sparta#Main">sparta.Main</a> defines the AWS CloudFormation stack that supports your application.  While the previous files represent different environments, they will collide at <code>provision</code> time since they share the same service name.</p>

<p>The <code>serviceName</code> can be specialized by using the <code>buildTags</code> in the service name definition as in:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SpartaHelloWorld-%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sparta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OptionsGlobal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildTags</span><span style="color:#000;font-weight:bold">),</span></code></pre></div>
<p>Each time you run <code>provision</code> with a unique <code>--tags</code> value, a new CloudFormation stack will be created.</p>

<p><em>NOTE</em>: This isn&rsquo;t something suitable for production use as there could be multiple <code>BuildTags</code> values.</p>

<h2 id="enforcing-environments">Enforcing Environments</h2>

<p>The final requirement is to add the environment name as a Stack Output. To annotate the stack with the output value, we&rsquo;ll register a <a href="https://godoc.org/github.com/mweagle/Sparta#ServiceDecoratorHook">ServiceDecorator</a> and use the same conditional compilation support to compile the environment-specific version.</p>

<p>The <em>main.go</em> source file registers the workflow hook via:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#000">hooks</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">sparta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkflowHooks</span><span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">Context</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}{},</span>
	<span style="color:#000">ServiceDecorator</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">environments</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceDecoratorHook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sparta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OptionsGlobal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildTags</span><span style="color:#000;font-weight:bold">),</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<p>Both <em>environments/staging.go</em> and <em>environments/production.go</em> define the same hook function:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ServiceDecoratorHook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buildTags</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">sparta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceDecoratorHook</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span>
		<span style="color:#000">serviceName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">template</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">gocf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Template</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">S3Bucket</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">buildID</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">awsSession</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Session</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">noop</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">logger</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Outputs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Environment&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">gocf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Output</span><span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">Description</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Sparta Config target environment&#34;</span><span style="color:#000;font-weight:bold">,</span>
			<span style="color:#000">Value</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<p>The <em>environments/default.go</em> definition is slightly different. The &ldquo;default&rdquo; environment isn&rsquo;t one that our service should actually deploy to. It simply exists to make the initial Sparta build (the one that cross compiles the AWS Lambda binary) compile.  Build tags are applied to the <em>AWS Lambda</em> compiled binary that Sparta generates.</p>

<p>To prevent users from accidentally deploying to the &ldquo;default&rdquo; environment, the <code>BuildTags</code> are valdiated in the hook definition:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ServiceDecoratorHook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buildTags</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">sparta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceDecoratorHook</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span>
		<span style="color:#000">serviceName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">template</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">gocf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Template</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">S3Bucket</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">buildID</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">awsSession</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Session</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">noop</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
		<span style="color:#000">logger</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buildTags</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Please provide a --tags value for environment target&#34;</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<h2 id="provisioning">Provisioning</h2>

<p>Putting everything together, the <code>SpartaConfig</code> service can deploy to either environment:</p>

<p><strong>staging</strong></p>

<pre><code>    go run main.go provision --level info --s3Bucket $(S3_BUCKET) --noop --tags staging
</code></pre>

<p><strong>production</strong></p>

<pre><code>    go run main.go provision --level info --s3Bucket $(S3_BUCKET) --noop --tags production
</code></pre>

<p>Attempting to deploy to &ldquo;default&rdquo; generates an error:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0000</span><span style="color:#ce5c00;font-weight:bold">]</span> Welcome to SpartaConfig-                      <span style="color:#000">Go</span><span style="color:#ce5c00;font-weight:bold">=</span>go1.7.1 <span style="color:#000">Option</span><span style="color:#ce5c00;font-weight:bold">=</span>provision <span style="color:#000">SpartaVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>.9.2 <span style="color:#000">UTC</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2016</span>-10-12T04:07:35Z
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0000</span><span style="color:#ce5c00;font-weight:bold">]</span> Provisioning service                          <span style="color:#000">BuildID</span><span style="color:#ce5c00;font-weight:bold">=</span>550c9e360426f48201c885c0abeb078dfc000a0a <span style="color:#000">NOOP</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> <span style="color:#000">Tags</span><span style="color:#ce5c00;font-weight:bold">=</span>
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0000</span><span style="color:#ce5c00;font-weight:bold">]</span> Verifying IAM Lambda execution roles
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0000</span><span style="color:#ce5c00;font-weight:bold">]</span> IAM roles verified                            <span style="color:#000">Count</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0000</span><span style="color:#ce5c00;font-weight:bold">]</span> Running <span style="color:#4e9a06">`</span>go generate<span style="color:#4e9a06">`</span>
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0000</span><span style="color:#ce5c00;font-weight:bold">]</span> Compiling binary                              <span style="color:#000">Name</span><span style="color:#ce5c00;font-weight:bold">=</span>SpartaConfig_.lambda.amd64
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0008</span><span style="color:#ce5c00;font-weight:bold">]</span> Executable binary size                        <span style="color:#000">KB</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">15309</span> <span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">14</span>
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0008</span><span style="color:#ce5c00;font-weight:bold">]</span> Creating ZIP archive <span style="color:#204a87;font-weight:bold">for</span> upload               <span style="color:#000">TempName</span><span style="color:#ce5c00;font-weight:bold">=</span>/Users/mweagle/Documents/gopath/src/github.com/mweagle/SpartaConfig/SpartaConfig_104207098
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0009</span><span style="color:#ce5c00;font-weight:bold">]</span> Registering Sparta <span style="color:#204a87;font-weight:bold">function</span>                   <span style="color:#000">FunctionName</span><span style="color:#ce5c00;font-weight:bold">=</span>main.helloWorld
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0009</span><span style="color:#ce5c00;font-weight:bold">]</span> Lambda <span style="color:#204a87;font-weight:bold">function</span> deployment package size       <span style="color:#000">KB</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4262</span> <span style="color:#000">MB</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0009</span><span style="color:#ce5c00;font-weight:bold">]</span> Bypassing bucket expiration policy check due to -n/-noop <span style="color:#204a87">command</span> line argument  <span style="color:#000">BucketName</span><span style="color:#ce5c00;font-weight:bold">=</span>weagle
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0009</span><span style="color:#ce5c00;font-weight:bold">]</span> Bypassing S3 upload due to -n/-noop <span style="color:#204a87">command</span> line argument  <span style="color:#000">Bucket</span><span style="color:#ce5c00;font-weight:bold">=</span>weagle <span style="color:#000">Key</span><span style="color:#ce5c00;font-weight:bold">=</span>SpartaConfig-/SpartaConfig_104207098
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0009</span><span style="color:#ce5c00;font-weight:bold">]</span> Calling WorkflowHook                          <span style="color:#000">WorkflowHook</span><span style="color:#ce5c00;font-weight:bold">=</span>github.com/mweagle/SpartaConfig/environments.ServiceDecoratorHook.func1 <span style="color:#000">WorkflowHookContext</span><span style="color:#ce5c00;font-weight:bold">=</span>map<span style="color:#ce5c00;font-weight:bold">[]</span>
INFO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0009</span><span style="color:#ce5c00;font-weight:bold">]</span> Invoking rollback functions                   <span style="color:#000">RollbackCount</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
ERRO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0009</span><span style="color:#ce5c00;font-weight:bold">]</span> Please provide a --tags value <span style="color:#204a87;font-weight:bold">for</span> environment target
Error: Please provide a --tags value <span style="color:#204a87;font-weight:bold">for</span> environment target
Usage:
  main provision <span style="color:#ce5c00;font-weight:bold">[</span>flags<span style="color:#ce5c00;font-weight:bold">]</span>

Flags:
  -i, --buildID string    Optional BuildID to use
  -s, --s3Bucket string   S3 Bucket to use <span style="color:#204a87;font-weight:bold">for</span> Lambda <span style="color:#204a87">source</span>
  -t, --tags string       Optional build tags to use <span style="color:#204a87;font-weight:bold">for</span> compilation

Global Flags:
  -l, --level string   Log level <span style="color:#ce5c00;font-weight:bold">[</span>panic, fatal, error, warn, info, debug<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;info&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
  -n, --noop           Dry-run behavior only <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">do</span> not perform mutations<span style="color:#ce5c00;font-weight:bold">)</span>

ERRO<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0009</span><span style="color:#ce5c00;font-weight:bold">]</span> Please provide a --tags value <span style="color:#204a87;font-weight:bold">for</span> environment target
<span style="color:#204a87">exit</span> status <span style="color:#0000cf;font-weight:bold">1</span></code></pre></div>
<h2 id="notes">Notes</h2>

<ul>
<li>Call <a href="https://godoc.org/github.com/mweagle/Sparta#ParseOptions">ParseOptions</a> to initialize  <code>sparta.OptionsGlobal.BuildTags</code> field for use in a service name definition.</li>
<li>An alternative approach is to define a custom <a href="https://godoc.org/github.com/mweagle/Sparta#ArchiveHook">ArchiveHook</a> and inject custom configuration into the ZIP archive. This data is available at <code>Path.Join(env.LAMBDA_TASK_ROOT, ZIP_ARCHIVE_PATH)</code>

<ul>
<li>See <a href="https://github.com/tmaiaroto/discfg">discfg</a>, <a href="https://github.com/coreos/etcd">etcd</a>, <a href="https://www.consul.io/">Consul</a> (among others) for alternative, more dynamic discovery services.</li>
</ul></li>
</ul>


    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="/reference/application/custom_flags/" title="Custom Flags"> <i class="fa fa-chevron-left"></i><label>Custom Flags</label></a>
    <a class="nav nav-next" href="/reference/application/workflow_hooks/" title="Workflow Hooks" style="margin-right: 0px;"><label>Workflow Hooks</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    

    

  
    <div class="date">
        <i class='fa fa-calendar'></i> Last update on 09/03/2016
    </div>
    

    <div class="github-link">
      <a href="https://github.com/mweagle/Sparta/tree/docs/content/reference/application/environments.md" target="blank"><i class="fa fa-code-fork"></i>
        Improve this page</a>
    </div>
  </div>


	<div>


  
    
  



	</div>
</footer>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>



<script src="/theme-flex/script.js"></script>

    

    
    

    
  </body>
</html>