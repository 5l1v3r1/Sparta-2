<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.51" />
    <meta name="description" content="Sparta - AWS Lambda Microservices">
<meta name="author" content="Matt Weagle">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Managing Environments :: Sparta - AWS Lambda Microservices</title>

    
    <link href="/css/nucleus.css?1543675870" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1543675870" rel="stylesheet">
    <link href="/css/hybrid.css?1543675870" rel="stylesheet">
    <link href="/css/featherlight.min.css?1543675870" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1543675870" rel="stylesheet">
    <link href="/css/auto-complete.css?1543675870" rel="stylesheet">
    <link href="/css/theme.css?1543675870" rel="stylesheet">
    <link href="/css/hugo-theme.css?1543675870" rel="stylesheet">
    
      <link href="/css/theme-sparta.css?1543675870" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1543675870"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
<style type="text/css">
pre {
    padding: 2px;
}
</style>


  </head>
  <body class="" data-url="/reference/application/environments/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/"><img src="/images/SpartaLogoNoDomain.png" height="50%" width="50%"/></a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1543675870"></script>
<script type="text/javascript" src="/js/auto-complete.js?1543675870"></script>
<script type="text/javascript">
    
        var baseurl = "\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1543675870"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/sample_service/" title="Sample Service" class="dd-item 
        
        
        parent
        ">
      <a href="/sample_service/">
          Sample Service
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/sample_service/step1/" title="Overview" class="dd-item ">
        <a href="/sample_service/step1/">
        Overview
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/sample_service/step2/" title="Details" class="dd-item ">
        <a href="/sample_service/step2/">
        Details
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/cli_options/" title="CLI Options" class="dd-item 
        
        
        
        ">
      <a href="/cli_options/">
          CLI Options
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/reference/" title="Reference" class="dd-item 
        parent
        
        
        ">
      <a href="/reference/">
          Reference
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/reference/eventsources/" title="" class="dd-item 
        
        
        
        ">
      <a href="/reference/eventsources/">
          <i class='fas fa-fw fa-cubes'></i>&nbsp;<b>Event Sources</b>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/cloudformation/" title="CloudFormation" class="dd-item ">
        <a href="/reference/eventsources/cloudformation/">
        CloudFormation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/cloudwatchevents/" title="CloudWatch Events" class="dd-item ">
        <a href="/reference/eventsources/cloudwatchevents/">
        CloudWatch Events
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/cloudwatchlogs/" title="CloudWatch Logs" class="dd-item ">
        <a href="/reference/eventsources/cloudwatchlogs/">
        CloudWatch Logs
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/cognito/" title="Cognito" class="dd-item ">
        <a href="/reference/eventsources/cognito/">
        Cognito
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/dynamodb/" title="DynamoDB" class="dd-item ">
        <a href="/reference/eventsources/dynamodb/">
        DynamoDB
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/kinesis/" title="Kinesis" class="dd-item ">
        <a href="/reference/eventsources/kinesis/">
        Kinesis
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/s3/" title="S3" class="dd-item ">
        <a href="/reference/eventsources/s3/">
        S3
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/ses/" title="SES" class="dd-item ">
        <a href="/reference/eventsources/ses/">
        SES
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/sns/" title="SNS" class="dd-item ">
        <a href="/reference/eventsources/sns/">
        SNS
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/sqs/" title="SQS" class="dd-item ">
        <a href="/reference/eventsources/sqs/">
        SQS
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/reference/eventsources/archetypes/" title="" class="dd-item 
        
        
        
        ">
      <a href="/reference/eventsources/archetypes/">
          <i class='fas fa-fw fa-flask'></i>&nbsp;<b>Archetype Constructors</b>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/archetypes/cloudwatch/" title="CloudWatch" class="dd-item ">
        <a href="/reference/eventsources/archetypes/cloudwatch/">
        CloudWatch
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/archetypes/dynamodb/" title="DynamoDB" class="dd-item ">
        <a href="/reference/eventsources/archetypes/dynamodb/">
        DynamoDB
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/archetypes/kinesis/" title="Kinesis" class="dd-item ">
        <a href="/reference/eventsources/archetypes/kinesis/">
        Kinesis
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/archetypes/rest/" title="REST Service" class="dd-item ">
        <a href="/reference/eventsources/archetypes/rest/">
        REST Service
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/archetypes/s3/" title="S3" class="dd-item ">
        <a href="/reference/eventsources/archetypes/s3/">
        S3
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/eventsources/archetypes/sns/" title="SNS" class="dd-item ">
        <a href="/reference/eventsources/archetypes/sns/">
        SNS
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/reference/apigateway/" title="" class="dd-item 
        
        
        
        ">
      <a href="/reference/apigateway/">
          <i class='fas fa-fw fa-globe'></i>&nbsp;<b>API Gateway</b>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/reference/apigateway/echo_event/" title="Echo Event" class="dd-item ">
        <a href="/reference/apigateway/echo_event/">
        Echo Event
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/apigateway/user_input/" title="User Input" class="dd-item ">
        <a href="/reference/apigateway/user_input/">
        User Input
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/apigateway/context/" title="Request Context" class="dd-item ">
        <a href="/reference/apigateway/context/">
        Request Context
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/apigateway/cors/" title="CORS" class="dd-item ">
        <a href="/reference/apigateway/cors/">
        CORS
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/apigateway/slack/" title="Slack SlashCommand" class="dd-item ">
        <a href="/reference/apigateway/slack/">
        Slack SlashCommand
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/apigateway/s3site/" title="S3 Sites with CORS" class="dd-item ">
        <a href="/reference/apigateway/s3site/">
        S3 Sites with CORS
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/reference/decorators/" title="" class="dd-item 
        
        
        
        ">
      <a href="/reference/decorators/">
          <i class='fas fa-fw fa-paint-brush'></i>&nbsp;<b>Build Time Decorators</b>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/reference/decorators/cloudfront_distribution/" title="CloudFront Distribution" class="dd-item ">
        <a href="/reference/decorators/cloudfront_distribution/">
        CloudFront Distribution
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/decorators/cloudwatch_alarm/" title="CloudWatch Alarm" class="dd-item ">
        <a href="/reference/decorators/cloudwatch_alarm/">
        CloudWatch Alarm
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/decorators/dashboard/" title="CloudWatch Dashboard" class="dd-item ">
        <a href="/reference/decorators/dashboard/">
        CloudWatch Dashboard
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/decorators/codedeployserviceupdate/" title="CodeDeploy Service Update" class="dd-item ">
        <a href="/reference/decorators/codedeployserviceupdate/">
        CodeDeploy Service Update
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/decorators/lambda_versioning/" title="Lambda Versioning Decorator" class="dd-item ">
        <a href="/reference/decorators/lambda_versioning/">
        Lambda Versioning Decorator
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/decorators/publish_outputs/" title="Publishing Outputs" class="dd-item ">
        <a href="/reference/decorators/publish_outputs/">
        Publishing Outputs
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/decorators/s3_artifact_publisher/" title="S3 Artifact Publisher" class="dd-item ">
        <a href="/reference/decorators/s3_artifact_publisher/">
        S3 Artifact Publisher
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/decorators/dynamic_infrastructure/" title="Dynamic Infrastructure" class="dd-item ">
        <a href="/reference/decorators/dynamic_infrastructure/">
        Dynamic Infrastructure
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/reference/interceptors/" title="" class="dd-item 
        
        
        
        ">
      <a href="/reference/interceptors/">
          <i class='fas fa-fw fa-puzzle-piece'></i>&nbsp;<b>Runtime Interceptors</b>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/reference/interceptors/xray_interceptor/" title="XRayInterceptor" class="dd-item ">
        <a href="/reference/interceptors/xray_interceptor/">
        XRayInterceptor
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/reference/application/" title="" class="dd-item 
        parent
        
        
        ">
      <a href="/reference/application/">
          <i class='fas fa-fw fa-cog'></i>&nbsp;<b>Application Customization</b>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/reference/application/custom_commands/" title="Custom Commands" class="dd-item ">
        <a href="/reference/application/custom_commands/">
        Custom Commands
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/application/custom_flags/" title="Custom Flags" class="dd-item ">
        <a href="/reference/application/custom_flags/">
        Custom Flags
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/application/environments/" title="Managing Environments" class="dd-item active">
        <a href="/reference/application/environments/">
        Managing Environments
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/application/custom_lambda_resources/" title="CloudFormation Resources" class="dd-item ">
        <a href="/reference/application/custom_lambda_resources/">
        CloudFormation Resources
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/application/custom_resources/" title="Custom Resources" class="dd-item ">
        <a href="/reference/application/custom_resources/">
        Custom Resources
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/discovery/" title="Discovery Service" class="dd-item ">
        <a href="/reference/discovery/">
        Discovery Service
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/docker/" title="Docker" class="dd-item ">
        <a href="/reference/docker/">
        Docker
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/hybrid_topologies/" title="Hybrid Topologies" class="dd-item ">
        <a href="/reference/hybrid_topologies/">
        Hybrid Topologies
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/step_functions/" title="Step Functions" class="dd-item ">
        <a href="/reference/step_functions/">
        Step Functions
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/reference/operations/" title="" class="dd-item 
        
        
        
        ">
      <a href="/reference/operations/">
          <i class='fas fa-fw fa-puzzle-piece'></i>&nbsp;<b>Operations</b>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/reference/operations/magefile/" title="Magefiles" class="dd-item ">
        <a href="/reference/operations/magefile/">
        Magefiles
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/operations/cicd/" title="CI/CD" class="dd-item ">
        <a href="/reference/operations/cicd/">
        CI/CD
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/operations/deployment_strategies/" title="Deployment Strategies" class="dd-item ">
        <a href="/reference/operations/deployment_strategies/">
        Deployment Strategies
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/operations/metrics_publisher/" title="Metrics Publisher" class="dd-item ">
        <a href="/reference/operations/metrics_publisher/">
        Metrics Publisher
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/operations/profiling/" title="Profiling" class="dd-item ">
        <a href="/reference/operations/profiling/">
        Profiling
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/reference/testing/" title="" class="dd-item 
        
        
        
        ">
      <a href="/reference/testing/">
          <i class='fas fa-fw fa-check-double'></i>&nbsp;<b>Testing</b>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/limitations/" title="Limitations" class="dd-item ">
        <a href="/reference/limitations/">
        Limitations
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/faq/" title="FAQ" class="dd-item ">
        <a href="/reference/faq/">
        FAQ
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/related_projects/" title="Related Projects" class="dd-item 
        
        
        
        ">
      <a href="/related_projects/">
          Related Projects
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/presentations/" title="Presentations" class="dd-item 
        
        
        
        ">
      <a href="/presentations/">
          Presentations
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/credits/" title="Credits" class="dd-item 
        
        
        
        ">
      <a href="/credits/">
          Credits
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/meta/" title="_Meta" class="dd-item 
        
        
        
        ">
      <a href="/meta/">
          _Meta
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/mweagle/Sparta"><i class='fab fa-fw fa-github'></i> Github repo</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://github.com/mweagle?utf8=%E2%9C%93&amp;tab=repositories&amp;q=Sparta&amp;type=&amp;language="><i class='fas fa-fw fa-camera'></i> Showcases</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://github.com/mweagle/Sparta/blob/master/CHANGES.md"><i class='fas fa-fw fa-signal'></i> Release History</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      
  Build: f1c79598<p/>
  Date: 2018-12-01 06:45:02 -0800 PST


<p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                  
                  
                  
                  <div id="top-github-link">
                    <a class="github-link" title='Edit this page' href="https://github.com/mweagle/Sparta/tree/docs/content/reference/application/environments.md" target="blank">
                      <i class="fas fa-code-branch"></i>
                      <span id="top-github-link-text">Edit this page</span>
                    </a>
                  </div>
                  
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'></a> > <a href='/reference/'>Reference</a> > <a href='/reference/application/'></a> > Managing Environments
          
         
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#default-configuration">Default Configuration</a></li>
<li><a href="#environment-configuration">Environment Configuration</a></li>
<li><a href="#segregating-services">Segregating Services</a></li>
<li><a href="#enforcing-environments">Enforcing Environments</a></li>
<li><a href="#provisioning">Provisioning</a></li>
<li><a href="#notes">Notes</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Managing Environments</h1>
          

        




<p>It&rsquo;s common for a single Sparta application to target multiple <em>environments</em>. For example:</p>

<ul>
<li>Development</li>
<li>Staging</li>
<li>Production</li>
</ul>

<p>Each environment is largely similar, but the application may need slightly different configuration in each context.</p>

<p>To support this, Sparta uses Go&rsquo;s <a href="http://dave.cheney.net/2013/10/12/how-to-use-conditional-compilation-with-the-go-build-tool">conditional compilation</a> support to ensure that configuration information is validated at build time.  Conditional compilation is supported via the <code>--tags/-t</code> command line argument.</p>

<p>This example will work through the <a href="https://github.com/mweagle/SpartaConfig">SpartaConfig</a> sample. The requirement is that each environment declare it&rsquo;s <code>Name</code> and also add that value as a Stack <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html">Output</a>.</p>

<h2 id="default-configuration">Default Configuration</h2>

<p>To start with, create the <em>default</em> configuration. This is the configuration that Sparta uses when provisioning your Stack and defines the environment configuration contract.</p>

<pre><code class="language-go">// +build !staging,!production
// file: environments/default.go

package environments

import (
  &quot;fmt&quot;
  &quot;github.com/Sirupsen/logrus&quot;
  &quot;github.com/aws/aws-sdk-go/aws/session&quot;
  gocf &quot;github.com/crewjam/go-cloudformation&quot;
  sparta &quot;github.com/mweagle/Sparta&quot;
)

// Name is the default configuration
const Name = &quot;&quot;
</code></pre>

<p>The important part is the set of excluded tags at the top of the file:</p>

<pre><code class="language-go">// +build !staging,!production
</code></pre>

<p>This ensures that the configuration is only eligible for compilation when Sparta goes to <code>provision</code> the service.</p>

<h2 id="environment-configuration">Environment Configuration</h2>

<p>The next steps are to define the environment-specific configuration files:</p>

<pre><code class="language-go">// +build staging
// file: environments/staging.go

package environments

import (
  &quot;github.com/Sirupsen/logrus&quot;
  &quot;github.com/aws/aws-sdk-go/aws/session&quot;
  gocf &quot;github.com/crewjam/go-cloudformation&quot;
  sparta &quot;github.com/mweagle/Sparta&quot;
)

// Name is the production configuration
const Name = &quot;staging&quot;

</code></pre>

<pre><code class="language-go">// +build production
// file: environments/production.go

package environments

import (
  &quot;github.com/Sirupsen/logrus&quot;
  &quot;github.com/aws/aws-sdk-go/aws/session&quot;
  gocf &quot;github.com/crewjam/go-cloudformation&quot;
  sparta &quot;github.com/mweagle/Sparta&quot;
)

// Name is the production configuration
const Name = &quot;production&quot;

</code></pre>

<p>These three files define the set of compile-time mutually-exclusive sources that represent environment targets.</p>

<h2 id="segregating-services">Segregating Services</h2>

<p>The <code>serviceName</code> argument supplied to <a href="https://godoc.org/github.com/mweagle/Sparta#Main">sparta.Main</a> defines the AWS CloudFormation stack that supports your application.  While the previous files represent different environments, they will collide at <code>provision</code> time since they share the same service name.</p>

<p>The <code>serviceName</code> can be specialized by using the <code>buildTags</code> in the service name definition as in:</p>

<pre><code class="language-go">fmt.Sprintf(&quot;SpartaHelloWorld-%s&quot;, sparta.OptionsGlobal.BuildTags),
</code></pre>

<p>Each time you run <code>provision</code> with a unique <code>--tags</code> value, a new CloudFormation stack will be created.</p>

<p><em>NOTE</em>: This isn&rsquo;t something suitable for production use as there could be multiple <code>BuildTags</code> values.</p>

<h2 id="enforcing-environments">Enforcing Environments</h2>

<p>The final requirement is to add the environment name as a Stack Output. To annotate the stack with the output value, we&rsquo;ll register a <a href="https://godoc.org/github.com/mweagle/Sparta#ServiceDecoratorHook">ServiceDecorator</a> and use the same conditional compilation support to compile the environment-specific version.</p>

<p>The <em>main.go</em> source file registers the workflow hook via:</p>

<pre><code class="language-go">hooks := &amp;sparta.WorkflowHooks{
  Context:          map[string]interface{}{},
  ServiceDecorator: environments.ServiceDecoratorHook(sparta.OptionsGlobal.BuildTags),
}
</code></pre>

<p>Both <em>environments/staging.go</em> and <em>environments/production.go</em> define the same hook function:</p>

<pre><code class="language-go">func ServiceDecoratorHook(buildTags string) sparta.ServiceDecoratorHook {
  return func(context map[string]interface{},
    serviceName string,
    template *gocf.Template,
    S3Bucket string,
    buildID string,
    awsSession *session.Session,
    noop bool,
    logger *logrus.Logger) error {
    template.Outputs[&quot;Environment&quot;] = &amp;gocf.Output{
      Description: &quot;Sparta Config target environment&quot;,
      Value:       Name,
    }
    return nil
  }
}
</code></pre>

<p>The <em>environments/default.go</em> definition is slightly different. The &ldquo;default&rdquo; environment isn&rsquo;t one that our service should actually deploy to. It simply exists to make the initial Sparta build (the one that cross compiles the AWS Lambda binary) compile.  Build tags are applied to the <em>AWS Lambda</em> compiled binary that Sparta generates.</p>

<p>To prevent users from accidentally deploying to the &ldquo;default&rdquo; environment, the <code>BuildTags</code> are validated in the hook definition:</p>

<pre><code class="language-go">func ServiceDecoratorHook(buildTags string) sparta.ServiceDecoratorHook {
  return func(context map[string]interface{},
    serviceName string,
    template *gocf.Template,
    S3Bucket string,
    buildID string,
    awsSession *session.Session,
    noop bool,
    logger *logrus.Logger) error {
    if len(buildTags) &lt;= 0 {
      return fmt.Errorf(&quot;Please provide a --tags value for environment target&quot;)
    }
    return nil
  }
}
</code></pre>

<h2 id="provisioning">Provisioning</h2>

<p>Putting everything together, the <code>SpartaConfig</code> service can deploy to either environment:</p>

<p><strong>staging</strong></p>

<pre><code>go run main.go provision --level info --s3Bucket $(S3_BUCKET) --noop --tags staging
</code></pre>

<p><strong>production</strong></p>

<pre><code>go run main.go provision --level info --s3Bucket $(S3_BUCKET) --noop --tags production
</code></pre>

<p>Attempting to deploy to &ldquo;default&rdquo; generates an error:</p>

<pre><code class="language-bash">INFO[0000] Welcome to SpartaConfig-                      Go=go1.7.1 Option=provision SpartaVersion=0.9.2 UTC=2016-10-12T04:07:35Z
INFO[0000] Provisioning service                          BuildID=550c9e360426f48201c885c0abeb078dfc000a0a NOOP=true Tags=
INFO[0000] Verifying IAM Lambda execution roles
INFO[0000] IAM roles verified                            Count=1
INFO[0000] Running `go generate`
INFO[0000] Compiling binary                              Name=SpartaConfig_.lambda.amd64
INFO[0008] Executable binary size                        KB=15309 MB=14
INFO[0008] Creating ZIP archive for upload               TempName=/Users/mweagle/Documents/gopath/src/github.com/mweagle/SpartaConfig/SpartaConfig_104207098
INFO[0009] Registering Sparta function                   FunctionName=main.helloWorld
INFO[0009] Lambda function deployment package size       KB=4262 MB=4
INFO[0009] Bypassing bucket expiration policy check due to -n/-noop command line argument  BucketName=weagle
INFO[0009] Bypassing S3 upload due to -n/-noop command line argument  Bucket=weagle Key=SpartaConfig-/SpartaConfig_104207098
INFO[0009] Calling WorkflowHook                          WorkflowHook=github.com/mweagle/SpartaConfig/environments.ServiceDecoratorHook.func1 WorkflowHookContext=map[]
INFO[0009] Invoking rollback functions                   RollbackCount=0
ERRO[0009] Please provide a --tags value for environment target
Error: Please provide a --tags value for environment target
Usage:
  main provision [flags]

Flags:
  -i, --buildID string    Optional BuildID to use
  -s, --s3Bucket string   S3 Bucket to use for Lambda source
  -t, --tags string       Optional build tags to use for compilation

Global Flags:
  -l, --level string   Log level [panic, fatal, error, warn, info, debug] (default &quot;info&quot;)
  -n, --noop           Dry-run behavior only (do not perform mutations)

ERRO[0009] Please provide a --tags value for environment target
exit status 1
</code></pre>

<h2 id="notes">Notes</h2>

<ul>
<li>Call <a href="https://godoc.org/github.com/mweagle/Sparta#ParseOptions">ParseOptions</a> to initialize  <code>sparta.OptionsGlobal.BuildTags</code> field for use in a service name definition.</li>
<li>An alternative approach is to define a custom <a href="https://godoc.org/github.com/mweagle/Sparta#ArchiveHook">ArchiveHook</a> and inject custom configuration into the ZIP archive. This data is available at <code>Path.Join(env.LAMBDA_TASK_ROOT, ZIP_ARCHIVE_PATH)</code></li>
<li>See <a href="https://github.com/tmaiaroto/discfg">discfg</a>, <a href="https://github.com/coreos/etcd">etcd</a>, <a href="https://www.consul.io/">Consul</a> (among others) for alternative, more dynamic discovery services.</li>
</ul>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/reference/application/custom_flags/" title="Custom Flags"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/reference/application/custom_lambda_resources/" title="CloudFormation Resources" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1543675870"></script>
    <script src="/js/perfect-scrollbar.min.js?1543675870"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1543675870"></script>
    <script src="/js/jquery.sticky.js?1543675870"></script>
    <script src="/js/featherlight.min.js?1543675870"></script>
    <script src="/js/html5shiv-printshiv.min.js?1543675870"></script>
    <script src="/js/highlight.pack.js?1543675870"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1543675870"></script>
    <script src="/js/learn.js?1543675870"></script>
    <script src="/js/hugo-learn.js?1543675870"></script>

    <link href="/mermaid/mermaid.css?1543675870" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1543675870"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70794971-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70794971-2');
</script>
  </body>
</html>

