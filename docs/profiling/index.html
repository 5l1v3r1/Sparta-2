<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Profiling - Sparta</title>
    <meta name="generator" content="Hugo 0.29" />

    
    <meta name="description" content="Sparta - Go framework for AWS Lambda">
    
    <link rel="canonical" href="http://gosparta.io/docs/profiling/">
    
    <meta name="author" content="Matt Weagle">
    

    <meta property="og:url" content="http://gosparta.io/docs/profiling/">
    <meta property="og:title" content="Sparta">
    <meta property="og:image" content="http://gosparta.io/images/SpartaHelmet.png">
    <meta name="apple-mobile-web-app-title" content="Sparta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="http://gosparta.io/favicons/favicon.ico">
    <link rel="icon" type="image/x-icon" href="http://gosparta.io/favicons/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('http://gosparta.io/fonts/icon.eot');
        src: url('http://gosparta.io/fonts/icon.eot')
               format('embedded-opentype'),
             url('http://gosparta.io/fonts/icon.woff')
               format('woff'),
             url('http://gosparta.io/fonts/icon.ttf')
               format('truetype'),
             url('http://gosparta.io/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="http://gosparta.io/stylesheets/application.css">
    <link rel="stylesheet" href="http://gosparta.io/stylesheets/temporary.css">
    <link rel="stylesheet" href="http://gosparta.io/stylesheets/palettes.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open%20Sans:400,700|Source&#43;Code&#43;Pro">
    <style>
      body, input {
        font-family: 'Open Sans', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Source Code Pro', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <link rel="stylesheet" href="http://gosparta.io/css/sparta.css">
    
    <link rel="stylesheet" href="http://gosparta.io/external/mermaid_dist/mermaid.css">
    
    <link rel="stylesheet" href="http://gosparta.io/external/font-awesome-4.7.0/css/font-awesome.min.css">
    
    <script src="http://gosparta.io/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-grey palette-accent-indigo">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Profiling
      </div>
    </div>

    
    <div class="button button-twitter" role="button" aria-label="Twitter">
       <a href="https://twitter.com/mweagle" title="@mweagle on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
    </div>
    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/mweagle" title="@mweagle on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/mweagle/Sparta" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="http://gosparta.io/images/SpartaHelmet.png">
        </div>
      
      <div class="name">
        <strong>Sparta <span class="version">0.20.4</span></strong>
        
          <br>
          mweagle/Sparta
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/mweagle/Sparta/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/mweagle/Sparta/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Sparta" href="http://gosparta.io/">
	
	Sparta
</a>



  
</li>



<li>
  
    



<a  title="Overview" href="http://gosparta.io/docs/overview">
	
	Overview
</a>



  
</li>



<li>
  
    



<a  title="Sample Service" href="http://gosparta.io/docs/intro_example/intro">
	
	Sample Service
</a>



  
</li>



<li>
  
    <span class="section">Documentation</span>
    <ul>
      
        
        



<a  title="Event Sources" href="http://gosparta.io/docs/eventsources/eventsources/">
	
	Event Sources
</a>



      
        
        



<a  title="API Gateway" href="http://gosparta.io/docs/apigateway/apigateway/">
	
	API Gateway
</a>



      
        
        



<a  title="S3 Sites with CORS" href="http://gosparta.io/docs/s3site/">
	
	S3 Sites with CORS
</a>



      
        
        



<a  title="Application Customization" href="http://gosparta.io/docs/application/application/">
	
	Application Customization
</a>



      
        
        



<a  title="Custom Resources" href="http://gosparta.io/docs/custom_resources/">
	
	Custom Resources
</a>



      
        
        



<a  title="Discovery Service" href="http://gosparta.io/docs/discovery/">
	
	Discovery Service
</a>



      
        
        



<a  title="Dynamic Infrastructure" href="http://gosparta.io/docs/dynamic_infrastructure/">
	
	Dynamic Infrastructure
</a>



      
        
        



<a  title="Python/cgo Support" href="http://gosparta.io/docs/cgo/">
	
	Python/cgo Support
</a>



      
        
        



<a  title="Docker" href="http://gosparta.io/docs/docker/">
	
	Docker
</a>



      
        
        



<a  title="Step Functions" href="http://gosparta.io/docs/step_functions/">
	
	Step Functions
</a>



      
        
        



<a  title="CI/CD" href="http://gosparta.io/docs/cicd/">
	
	CI/CD
</a>



      
        
        



<a  title="Local Testing" href="http://gosparta.io/docs/local_testing/">
	
	Local Testing
</a>



      
        
        



<a class="current" title="Profiling" href="http://gosparta.io/docs/profiling/">
	
	Profiling
</a>


<ul id="scrollspy">
</ul>


      
        
        



<a  title="Hybrid Topologies" href="http://gosparta.io/docs/hybrid_topologies/">
	
	Hybrid Topologies
</a>



      
    </ul>
  
</li>



<li>
  
    



<a  title="Presentations" href="http://gosparta.io/docs/presentations">
	
	Presentations
</a>



  
</li>



<li>
  
    



<a  title="Limitations" href="http://gosparta.io/docs/limitations">
	
	Limitations
</a>



  
</li>



<li>
  
    



<a  title="FAQ" href="http://gosparta.io/docs/faq">
	
	FAQ
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          
          <li>
            <a href="https://twitter.com/mweagle" target="_blank" title="@mweagle on Twitter">
              @mweagle on Twitter
            </a>
          </li>
          

          
          <li>
            <a href="https://github.com/mweagle" target="_blank" title="@mweagle on GitHub">
              @mweagle on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:mweagle@gmail.com" title="Email of mweagle@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Profiling </h1>

			

<h1 id="introduction">Introduction</h1>

<p>One of Lambda&rsquo;s biggest strengths, its ability to automatically scale across ephemeral containers in response to increased load, also creates one of its biggest problems: observability. The traditional set of <a href="https://jvns.ca/">tools</a> used to identify performance bottlenecks are no longer valid, as there is no host into which one can SSH and interactively interrogate. Identifying performance bottlenecks is even more significant due to the Lambda <a href="https://aws.amazon.com/lambda/pricing/">pricing model</a>, where idle time often directly translates into increased costs.</p>

<p>However, Go offers the excellent <a href="https://rakyll.org/pprof-ui/">pprof</a> tool to visualize and cost allocate program execution. Beginning with <a href="https://github.com/mweagle/Sparta/blob/master/CHANGES.md#v0204">Sparta 0.20.4</a>, it&rsquo;s possible to enable per-lambda instance snapshotting which can be locally visualized. This documentation provides an overview of how to enable profiling. The full source is available at the <a href="https://github.com/mweagle/SpartaPProf">SpartaPProf</a> repo.</p>

<p>To learn more about <code>pprof</code> itself, please visit:</p>

<ul>
<li><a href="https://twitter.com/rakyll" class="fa fa-twitter">@rakyll&rsquo;s</a> <a href="https://rakyll.org/">blog</a></li>
<li><a href="https://jvns.ca/blog/2017/09/24/profiling-go-with-pprof/">Profiling Go programs with pprof</a></li>
<li><a href="https://medium.com/@tjholowaychuk/profiling-golang-851db2d9ae24">Profiling Golang</a></li>
<li><a href="http://artem.krylysov.com/blog/2017/03/13/profiling-and-optimizing-go-web-applications/">Profiling and optimizing Go web programs</a></li>
</ul>

<h2 id="enabling-profiling">Enabling Profiling</h2>

<p>To enable profiling add a reference to <a href="https://godoc.org/github.com/mweagle/Sparta#ScheduleProfileLoop">ScheduleProfileLoop</a> in your <code>main()</code> function as in:</p>

<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">sparta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScheduleProfileLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">30</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;goroutine&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;heap&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;threadcreate&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;block&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;mutex&#34;</span><span style="color:#000;font-weight:bold">)</span></code></pre>
</div>

<p>This function accepts the following arguments:</p>

<ul>
<li><code>s3Bucket</code>: The S3 bucket to which profile snapshots should be written. If <code>nil</code>, the bucket used to host the original ZIP code archive is used.</li>
<li><code>snapshotInterval</code> - The interval between each snapshot.</li>
<li><code>cpuProfileDuration</code> - The duration for the <a href="https://golang.org/pkg/runtime/pprof/#StartCPUProfile">CPUProfile</a> sample.</li>
<li><code>profileNames...</code> - The profile types to snapshot. In addition to the <a href="https://golang.org/pkg/runtime/pprof/#Profile">standard profiles</a>, Sparta includes a &ldquo;cpu&rdquo; profile iff the <code>cpuProfileDuration</code> is non-zero.</li>
</ul>

<h3 id="profiling-implementation">Profiling Implementation</h3>

<p>During the <code>provision</code> step, the <code>ScheduleProfileLoop</code> adds an <a href="https://godoc.org/github.com/mweagle/Sparta#IAMRolePrivilege">IAMRolePrivilege</a> <em>Enable</em> entry (if possible) to each Lambda function&rsquo;s IAM policy. It also annotates the Lambda&rsquo;s <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html#cfn-lambda-function-environment">Environment</a> map so that the publishing loop knows where to publish snapshots.</p>

<p>During the <code>execute</code> step when the Sparta binary is executing in AWS Lambda, the <code>ScheduleProfileLoop</code> installs the requestd sampling and publishing steps so that profile snapshots, serialized as <a href="https://github.com/google/pprof/blob/master/proto/profile.proto">proto</a> files, are properly saved to S3. Profiles are published to a reserved location in S3 with the form:</p>

<p>s3:://{BUCKET_NAME}/sparta/pprof/{STACK_NAME}/profiles/{PROFILE_TYPE}/{SNAPSHOT_INDEX}-{PROFILE_TYPE}.λ-{INSTANCE_ID}.profile</p>

<p>To manage profile sprawl, each lambda instance uses a rolling <code>SNAPSHOT_INDEX</code> to maintain a fixed size window. The new <code>profile</code> command is responsible for aggregating them into a single consolidated profile that can be visualized.</p>

<h2 id="deploying">Deploying</h2>

<p>With profiling enabled, the next step is to deploy the <em>SpartaPProf</em> service using the <code>provision</code> command:</p>

<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">INFO[0000] ══════════════════════════════════════════════════════════════
INFO[0000]    _______  ___   ___  _________
INFO[0000]   / __/ _ \/ _ | / _ \/_  __/ _ |     Version : 0.20.4
INFO[0000]  _\ \/ ___/ __ |/ , _/ / / / __ |     SHA     : 8f97d81
INFO[0000] /___/_/  /_/ |_/_/|_| /_/ /_/ |_|     Go      : go1.9.1
INFO[0000] ══════════════════════════════════════════════════════════════
INFO[0000] Service: SpartaPProf-mweagle                  LinkFlags= Option=provision UTC=&#34;2017-11-26T19:21:17Z&#34;
INFO[0000] ══════════════════════════════════════════════════════════════
INFO[0000] Provisioning service                          BuildID=441b46af4f35566d5cf2f2b4a7992bedc8825ecf CodePipelineTrigger= InPlaceUpdates=false NOOP=false Tags=
INFO[0000] Verifying IAM Lambda execution roles
INFO[0000] Instrumenting function for profiling          Function=Hello_World
INFO[0000] IAM roles verified                            Count=1
INFO[0000] Checking S3 versioning                        Bucket=weagle VersioningEnabled=true
INFO[0000] Running `go generate`
INFO[0000] Compiling binary                              Name=Sparta.lambda.amd64
INFO[0010] Executable binary size                        KB=23082 MB=22
INFO[0010] Creating code ZIP archive for upload          TempName=./.sparta/SpartaPProf_mweagle-code.zip
INFO[0010] Creating NodeJS/Sparta proxy function         FunctionName=Hello_World ScriptName=Hello_World
INFO[0010] Lambda code archive size                      KB=23182 MB=22
INFO[0010] Uploading local file to S3                    Bucket=weagle Key=SpartaPProf-mweagle/SpartaPProf_mweagle-code.zip Path=./.sparta/SpartaPProf_mweagle-code.zip
INFO[0028] Uploading local file to S3                    Bucket=weagle Key=SpartaPProf-mweagle/SpartaPProf_mweagle-cftemplate.json Path=./.sparta/SpartaPProf_mweagle-cftemplate.json
INFO[0028] Creating stack                                StackID=&#34;arn:aws:cloudformation:us-west-2:012345678910:stack/SpartaPProf-mweagle/0a802640-d2df-11e7-88d8-50a68a0e328e&#34;
INFO[0049] Waiting for CloudFormation operation to complete
INFO[0062] Stack output                                  Description=&#34;Lambda function ARN&#34; Key=FunctionARN Value=&#34;arn:aws:lambda:us-west-2:012345678910:function:SpartaPProf-mweagle-Hello_World&#34;
INFO[0062] Stack provisioned                             CreationTime=&#34;2017-11-26 19:21:45.446 +0000 UTC&#34; StackId=&#34;arn:aws:cloudformation:us-west-2:012345678910:stack/SpartaPProf-mweagle/0a802640-d2df-11e7-88d8-50a68a0e328e&#34; StackName=SpartaPProf-mweagle
INFO[0062] ──────────────────────────────────────────────────────────────
INFO[0062] SpartaPProf-mweagle Summary (2017-11-26T11:22:19-08:00)
INFO[0062] ──────────────────────────────────────────────────────────────
INFO[0062] Verifying IAM roles                           Duration (s)=0
INFO[0062] Verifying AWS preconditions                   Duration (s)=0
INFO[0062] Creating code bundle                          Duration (s)=10
INFO[0062] Uploading code                                Duration (s)=17
INFO[0062] Ensuring CloudFormation stack                 Duration (s)=34
INFO[0062] Total elapsed time                            Duration (s)=62
INFO[0062] ──────────────────────────────────────────────────────────────</code></pre>
</div>

<h2 id="generating-load">Generating Load</h2>

<p>While the <strong>SpartaPProf</strong> binary does include functions that are likely to generate profiling data, we still need to issue a sufficient series of events to produce a non-empty profile data set. <strong>SpartaPProf</strong> includes a simple tool (<em>cmd/load.go</em>) that directly calls the provisioned lambda function on a regular interval. It accepts a single command line argument, the <em>ARN</em> of the lambda function listed as a <em>Stack output</em> in the log output:</p>

<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">INFO[0062] Stack output                                  Description=&#34;Lambda function ARN&#34; Key=FunctionARN Value=&#34;arn:aws:lambda:us-west-2:012345678910:function:SpartaPProf-mweagle-Hello_World&#34;</code></pre>
</div>

<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">$ cd cmd
$ go run load.go arn:aws:lambda:us-west-2:012345678910:function:SpartaPProf-mweagle-Hello_World
Lambda response (0 of 500): &#34;Hi there 🌍&#34;
Lambda response (1 of 500): &#34;Hi there 🌍&#34;
Lambda response (2 of 500): &#34;Hi there 🌍&#34;
Lambda response (3 of 500): &#34;Hi there 🌍&#34;
Lambda response (4 of 500): &#34;Hi there 🌍&#34;
Lambda response (5 of 500): &#34;Hi there 🌍&#34;
Lambda response (6 of 500): &#34;Hi there 🌍&#34;
Lambda response (7 of 500): &#34;Hi there 🌍&#34;
Lambda response (8 of 500): &#34;Hi there 🌍&#34;
Lambda response (9 of 500): &#34;Hi there 🌍&#34;
...</code></pre>
</div>

<p>After about thirty seconds or so, which took about 60 requests for this sample against a stack provisioned in <code>us-west-2</code>, a set of named profiles was published. Since each container&rsquo;s instance id is randomly assigned, the profile names you see will have slightly different names</p>

<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">---------------------------------------------------------------
S3 bucket: s3://weagle/sparta/pprof/SpartaPProf-mweagle/profiles
---------------------------------------------------------------
2017-11-26 11:32:28   41 Bytes sparta/pprof/SpartaPProf-mweagle/profiles/block/0-block.λ-3838737145763622974.profile
2017-11-26 11:32:27    1.8 KiB sparta/pprof/SpartaPProf-mweagle/profiles/cpu/0-cpu.λ-3838737145763622974.profile
2017-11-26 11:32:28    1.8 KiB sparta/pprof/SpartaPProf-mweagle/profiles/goroutine/0-goroutine.λ-3838737145763622974.profile
2017-11-26 11:32:28    2.2 KiB sparta/pprof/SpartaPProf-mweagle/profiles/heap/0-heap.λ-3838737145763622974.profile
2017-11-26 11:32:28   54 Bytes sparta/pprof/SpartaPProf-mweagle/profiles/mutex/0-mutex.λ-3838737145763622974.profile
2017-11-26 11:32:30  200 Bytes sparta/pprof/SpartaPProf-mweagle/profiles/threadcreate/0-threadcreate.λ-3838737145763622974.profile</code></pre>
</div>

<h2 id="visualizing-profiles">Visualizing Profiles</h2>

<p>Sparta delegates to the pprof <a href="https://github.com/google/pprof">webui</a> to visualize profile snapshots. Ensure you have the latest version of this by running <code>go get -u -v go get github.com/google/pprof</code> first.</p>

<p>The final step is to provide the profile snapshots to <code>pprof</code>. Sparta exposes a <code>profile</code> command that accomplishes this, by fetching and consolidating all published profiles for a single type.</p>

<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">$ go run main.go profile --s3Bucket weagle
INFO[0000] ══════════════════════════════════════════════════════════════
INFO[0000]    _______  ___   ___  _________
INFO[0000]   / __/ _ \/ _ | / _ \/_  __/ _ |     Version : 0.20.4
INFO[0000]  _\ \/ ___/ __ |/ , _/ / / / __ |     SHA     : 8f97d81
INFO[0000] /___/_/  /_/ |_/_/|_| /_/ /_/ |_|     Go      : go1.9.1
INFO[0000] ══════════════════════════════════════════════════════════════
INFO[0000] Service: SpartaPProf-mweagle                  LinkFlags= Option=profile UTC=&#34;2017-11-26T20:03:55Z&#34;
INFO[0000] ══════════════════════════════════════════════════════════════
? Which stack would you like to profile: SpartaPProf-mweagle
? What type of profile would you like to view? heap
? What profile snapshot(s) would you like to view? Download new snapshots from S3
? Please select a heap profile type: alloc_space
INFO[0010] Refreshing cached profiles                    CacheRoot=.sparta/profiles/SpartaPProf-mweagle/heap ProfileRootKey=sparta/pprof/SpartaPProf-mweagle/profiles/heap S3Bucket=weagle StackName=SpartaPProf-mweagle Type=heap
INFO[0010] Aggregating profile                           Input=&#34;.sparta/profiles/SpartaPProf-mweagle/heap/0-heap.λ-3838737145763622974.profile&#34;
INFO[0010] Consolidating profiles                        ProfileCount=1
INFO[0010] Creating consolidated profile                 ConsolidatedProfile=.sparta/heap.consolidated.profile
INFO[0010] Starting pprof webserver on http://localhost:8080. Enter Ctrl+C to exit.</code></pre>
</div>

<p>The <code>profile</code> command downloads the published profiles and consolidates them into a single cached version in the <em>./sparta</em> directory with a name of the form:</p>

<p>./.sparta/{PROFILE_TYPE}.consolidated.profile</p>

<p>You can choose to use the cached file if it exists.</p>

<p>For this sample run, the <em>heap</em> profile output is made available to the <code>pprof</code> webserver which produces the following layout:</p>

<p><img src="http://gosparta.io/images/profiling/main_alloc_space.jpg" alt="Main Alloc Space" /></p>

<p>The latest <code>pprof</code> also includes flamegraph support to help identify issues:</p>

<p><img src="http://gosparta.io/images/profiling/main_alloc_space_flamegraph.jpg" alt="Main Alloc Space Flamegraph" /></p>

<p>To view another profile type, enter <code>Ctrl+C</code> to exit the blocking web ui loop and launch another <code>profile</code> session.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Go includes a very powerful set of tools that can help diagnose performance bottlenecks. With the Sparta <code>profile</code> command, it&rsquo;s possible to bring that same visibility to bear to AWS Lambda, despite running on ephemeral, (typically) unaddressable hosts. Get started optimizing today! And also, don&rsquo;t forget to disable the profiling loop before pushing to production.</p>

<h1 id="notes">Notes</h1>

<ul>
<li><a href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html">CPU Flame Graphs</a> provides a great overview.</li>
<li>It&rsquo;s not currently possible to use <a href="https://medium.com/@cep21/creating-custom-go-profiles-with-pprof-b737dfc58e11">custom profiles</a></li>
<li>Lambda instances are limited to a window size of 3 rolling snapshots</li>
<li>The <code>explore</code> command also exposes the <code>pprof</code> <a href="https://github.com/mweagle/Sparta/blob/ead2872585dc0da81f222577a898707c6a486ab1/execute_utils.go#L35">web handlers</a> for local exploration as well.</li>
</ul>


			<aside class="copyright" role="note">
				
				&copy; 2017 Copyright 2015-2017 Matt Weagle &ndash;
				
				Last built at <b>2017-10-31 18:20:05 &#43;0000 UTC</b> with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="http://gosparta.io/docs/application/environments/" title="Managing Environments">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Managing Environments
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="http://gosparta.io/docs/cgo/" title="Python/cgo Support">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Python/cgo Support
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>


    <script>
    
      var base_url = 'http:\/\/gosparta.io\/';
      var repo_id  = 'mweagle\/Sparta';
    
    </script>

    <script src="http://gosparta.io/javascripts/application.js"></script>
    
    <script src="http://gosparta.io/external/mermaid_dist/mermaid.min.js"></script>
    
    <script src="http://gosparta.io/external/jquery/jquery-2.2.0.min.js"></script>
    

    
    <script>mermaid.initialize({startOnLoad:true});</script>


    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-70794971-1', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
         
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    

  </body>
</html>

